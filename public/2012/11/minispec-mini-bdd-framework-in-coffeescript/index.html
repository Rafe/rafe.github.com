
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Minispec : mini BDD framework in coffeescript - Neethack</title>
  <meta name="author" content="Jimmy Chao">

  
  <meta name="description" content="Just another test framework During the catastrophe of Sandy storm, my place have no electricity and water, so I stay in my friends place for whole &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://neethack.com/2012/11/minispec-mini-bdd-framework-in-coffeescript">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/neethack" rel="alternate" title="Neethack" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9904130-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Neethack</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/neethack" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:neethack.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://github.com/rafe">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Minispec : Mini BDD Framework in Coffeescript</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-07T15:16:00-05:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Just another test framework</h2>

<p>During the catastrophe of Sandy storm, my place have no electricity and water, so I stay in my friends place for whole week.
And I need to find something to do except eating, surfing internet and boardgame.
So I just wrote another test framework.</p>

<p>Inspired by Zach Holoman&#8217;s <a href="https://gist.github.com/1806986">gist</a>
I try to host the framework in the gist form. Because every gist is also a git repository.</p>

<p><a href="https://gist.github.com/4033566">gist source</a></p>

<!-- more -->


<h2>Spec</h2>

<p>The README.md file is also a runnable spec in coffeescript.
run</p>

<pre><code>npm test
</code></pre>

<p>in project can execute the spec</p>

<div><script src='https://gist.github.com/4033566.js?file=README.md'></script>
<noscript><pre><code># Minispec
#### minispec is a mini bdd test framework example
    # npm install git://gist.github.com/4033566.git

    # require('minispec') in your project
    require('./minispec')

    # use expect.js for assertion (http://n37.co/aemDq)
    expect = require('expect.js')

    user = &quot;&quot;
    describe &quot;Minispec&quot;, -&gt;
      before -&gt;
        user = name: &quot;Jimmy&quot;

      it 'can success', -&gt;
        expect(true).to.be.ok()

      it 'can fail', -&gt;
        expect().fail -&gt;

      it 'have before', -&gt;
        expect(user.name).to.equal &quot;Jimmy&quot;

      describe 'after', -&gt;

        after -&gt;
          throw new Error('in after')

        it 'will be executed', -&gt;
          expect(true).to.be.ok()

      describe 'nested describe', -&gt;
        before -&gt;
          user.password = '123'

        it 'with nested before', -&gt;
          expect(user.password).to.be '123'

        it 'with nested after', -&gt;
          expect(user.password).to.be '123'

        it 'can also have error', -&gt;
          expect().fail -&gt;

        describe 'nested in nested', -&gt;
          it 'is nested', -&gt;
            expect(1).to.be.ok()

      describe 'async function', -&gt;

        it 'have callback', (done)-&gt;
          expect(1).to.be.ok()
          done()
</code></pre></noscript></div>


<h2>Global delegation</h2>

<p>One of the problem is the format of syntax.
Because I want to write syntax without extra <code>this</code> keyword, so instead of calling the test block with &#8216;call&#8217;,
I have to declare test syntax globally.</p>

<pre><code>#Instead this
describe = (title, block)-&gt;
  @it = (desc, fn)-&gt;
    #add test to test suite
  block.call(@)

describe "syntax", -&gt;
  @it "have this keyword", -&gt;

#Got to do it Globally
global.it = (desc, fn)-&gt;
  #add test to test suite
describe = (title, block)-&gt;
  block()

describe "syntax", -&gt;
  it "have no this keyword", -&gt;
</code></pre>

<p>But there&#8217;s 2 problem of declaring global, one is the confrontation of global keywords, which is a tradeoff for simpler syntax.
Another problem is when implementing nested block, test need to be delegated into right suite.
Using a stack to track the current suite can solve this problem.</p>

<pre><code>suites = []
global.it = (desc, fn)-&gt; 
  suites[0].tests.push title: desc, fn: fn

describe = (title, block)-&gt;
  suite = new Suite(title)
  suites.unshift(suite)
  block()
  suites.shift()
</code></pre>

<p>So the global <code>it</code> will always add test to the top of stack, which is the current test suite.</p>

<h2>Hook and run</h2>

<p>For the before/after function, I use the EventEmitter to trigger the hooks, and delegate event to the parent suite:</p>

<pre><code>class Suite extends EventEmitter
  constructor: (@title, @parent)-&gt;
    ...
    @delegate ['before', 'after']
    @on 'result', @reportResult
    @on 'end', @reportSummary

  delegate: (events)-&gt;
    events.forEach (event)=&gt;
      @on event, =&gt; @parent?.emit event

  run: -&gt;
    @emit 'start'
    @tests.forEach (test)-&gt;
      try
        @emit 'before'
        test.fn()
        @emit 'result', test
        @emit 'after'
      catch err
        @emit 'result', test, err
    @emit 'end'
</code></pre>

<h2>Async</h2>

<p>For testing the async callback, <code>it</code> also provide a done callback for the async function.
And I use <a href="https://github.com/caolan/async">async</a> module to handle the test execution sequence.
It will detect the function param, if there is a specific callback param in function, execute in async mode.</p>

<h2>Source</h2>

<div><script src='https://gist.github.com/4033566.js?file=minispec.coffee'></script>
<noscript><pre><code>{EventEmitter} = require 'events'
async = require 'async'

#utils
color = (code)-&gt; (text = &quot;&quot;)-&gt; code + text + '\u001b[0m'
red = color('\u001b[31m')
green = color('\u001b[32m')
yellow = color('\u001b[33m')
pluralize = (count, noun)-&gt; if count &gt; 1 then noun + 's' else noun
indent = (level)-&gt; ('  ' for i in [0...level]).join('')

class Suite extends EventEmitter
  constructor: (@title, @parent)-&gt;
    @errors = 0
    @tests = []
    @childs = []
    @parent?.childs.push @
    @level = @parent?.level + 1 or 0

    @on 'start', =&gt; @report yellow @title
    @delegate ['before', 'after'] if @parent?
    @on 'result', (test, err)=&gt;
      if err?
        @errors += 1
        @report red &quot;  ✗ #{test.title} (#{err})&quot;
      else
        @report green &quot;  ✓ #{test.title}&quot;
    @on 'end', =&gt;
      count = @tests.length
      errors = @errors

      (reduce = (suites)-&gt;
        suites.forEach (suite)-&gt;
          count += suite.tests.length
          errors += suite.errors
          reduce suite.childs if suite.childs?
      )(@childs)

      console.log yellow &quot;run #{count} #{pluralize(count, 'test') } , #{count - errors} success, #{errors} failed&quot;

  delegate: (events)-&gt;
    events.forEach (event)=&gt;
      @on event, ()=&gt; @parent?.emit event

  report: (text)-&gt; console.log indent(@level) + text

  run: -&gt;
    @emit 'start'
    async.forEachSeries @tests, (test, next)=&gt;
      callback = =&gt;
        @emit('after')
        @emit('result', test)
        next()

      try
        @emit('before')
        if test.isAsync
          test.fn callback
        else
          test.fn()
          callback()
      catch err
        @emit('result', test, err)
        next()
    , =&gt;
      @childs.forEach (spec)-&gt; spec.run()
      @emit 'end' unless @parent?

class Runner
  constructor: (context)-&gt;
    suites = []
    context.it = (desc, fn)-&gt;
      suites[0].tests.push title: desc, fn: fn, isAsync: !!fn.length
    context.before = (fn)-&gt;
      suites[0].on 'before', fn
    context.after = (fn)-&gt;
      suites[0].on 'after', fn
    context.describe = (title, block)-&gt;
      suite = new Suite(title, suites[0])
      suites.unshift(suite)
      block()
      suites.shift()
      suite.run() if suites.length is 0

new Runner(global or window)
</code></pre></noscript></div>


<h2>Summary</h2>

<p>Credit to VisionMedia&#8217;s <a href="https://github.com/visionmedia/mocha">mocha</a> framework, lots of solution is comming from there.</p>

<p>But still this is an intersting small project to do in the storm days.</p>

<p>And I am so happy to back to the normal life.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jimmy Chao</span></span>

      








  


<time datetime="2012-11-07T15:16:00-05:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/categories/coffee-script/'>coffee-script</a>, <a class='category' href='/categories/test/'>test</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://neethack.com/2012/11/minispec-mini-bdd-framework-in-coffeescript/" data-via="jimchaos" data-counturl="http://neethack.com/2012/11/minispec-mini-bdd-framework-in-coffeescript/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/09/reading-the-lean-startup/" title="Previous Post: Reading: The Lean Startup">&laquo; Reading: The Lean Startup</a>
      
      
        <a class="basic-alignment right" href="/2012/12/announcing-papercut/" title="next Post: Announcing Papercut">Announcing Papercut &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="about">
  <h1>About Me</h1>
  <div class="avator">
    <img src="/images/JimmyChao.jpg" width="85" alt="Jimchao"/>
  </div>
  <div class="bio clear">
    <p>
      Jimmy Chao, A programmer, newbie hacker and web developer live in New York.
      You can contact me at daizenga[at]gmail.com. Or follow my code at 
      <a href="https://github.com/Rafe">Github</a>.
    </p>
  </div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/04/announcing-code-warrior/">Announcing Code-Warrior</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/bacon-dot-js-for-dummies/">Bacon.js for dummies</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/express-bigpipe-experiment/">express bigpipe experiment</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/understand-event-loops/">Understand event loops</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/review-2012/">Review of 2012</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jimchaos", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jimchaos" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jimchaos</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jimmy Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'neethack';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://neethack.com/2012/11/minispec-mini-bdd-framework-in-coffeescript/';
        var disqus_url = 'http://neethack.com/2012/11/minispec-mini-bdd-framework-in-coffeescript/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
