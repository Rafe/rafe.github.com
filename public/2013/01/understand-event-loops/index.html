
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Understand event loops - Neethack</title>
  <meta name="author" content="Jimmy Chao">

  
  <meta name="description" content="Event loop is the core feature in node.js,
and is also the reason why it is better on handling requests and realtime communication like long polling &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://neethack.com/2013/01/understand-event-loops">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/neethack" rel="alternate" title="Neethack" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9904130-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Neethack</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/neethack" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:neethack.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://github.com/rafe">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Understand Event Loops</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-09T18:02:00-05:00" pubdate data-updated="true">Jan 9<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Event loop is the core feature in node.js,
and is also the reason why it is better on handling requests and realtime communication like long polling.</p>

<h2>The Obstacle of IO</h2>

<p>The reason is on this is because the I/O is expensive:</p>

<!--more-->


<ul>
<li>L1/cache: 3 cycles</li>
<li>L2/cache: 14 cycles</li>
<li>RAM: 250 cycles</li>
<li>Disk: 41,000,000 cycles</li>
<li>Network: 240,000,000 cycles</li>
</ul>


<p>In the case like web application, every request is not computing heavy but require lots of access on database and disk.
So the most time-costing task in a request is waiting database or disk to response.</p>

<p>To solve this problems, the application servers running multiprocess or multithread
to make it able to handle more request at same time.
however, the new process solution will cost large among of memory because the each fork will copy the memory data to new process.
Thread solution is more kindly on memory but still cost more memory.</p>

<h2>What is event loops?</h2>

<p>So the event loops become the solution of this.</p>

<h3>Asynchronous I/O aka Evented I/O</h3>

<p>The problem of I/O obstacle, is because I/O can run concurrently, but your code is not,
So while the code is accessing the I/O, the process can only idle and wait for the response:</p>

<p>Sync I/O in node.js:</p>

<pre><code>fs = require('fs')

var data = fs.readFileSync('file.txt')
// wait for IO to return content
console.log(data)
</code></pre>

<p>But with event loop, the program don&rsquo;t need to wait for the I/O but can handle next task directly.</p>

<pre><code>fs = require('fs')

fs.readFile('file.txt', function(err, data){
  // Called when data is ready
  console.log(data)
});
// returns
</code></pre>

<p>The node.js event loop is using <a href="https://github.com/joyent/libuv">libuv</a> to handle the I/O multiplex
in the core function of libuv:</p>

<pre><code>//src/unix/core.c
int uv_run2(uv_loop_t* loop, uv_run_mode mode) {
  int r;

  if (!uv__loop_alive(loop))
    return 0;

  do {
    uv__update_time(loop);
    uv__run_timers(loop);
    uv__run_idle(loop);
    uv__run_prepare(loop);
    uv__run_pending(loop);
    uv__io_poll(loop, (mode &amp; UV_RUN_NOWAIT ? 0 : uv_backend_timeout(loop)));
    uv__run_check(loop);
    uv__run_closing_handles(loop);
    r = uv__loop_alive(loop);
  } while (r &amp;&amp; !(mode &amp; (UV_RUN_ONCE | UV_RUN_NOWAIT)));

  return r;
}
</code></pre>

<p>We can know the event loop is just a while loop, what it do is keep polling I/O for avalible fd(<a href="http://en.wikipedia.org/wiki/File_descriptor">file descriptor</a>)
and trigger event callback while the fd is ready.</p>

<p>in unix, there&rsquo;s multiple way to polling fd:</p>

<ul>
<li>select</li>
<li>poll</li>
<li>epoll (linux)</li>
<li>kqueue (BSD, unix, osx)</li>
</ul>


<p>node.js is using kqueue on mac os/unix.</p>

<h2>Reactor pattern</h2>

<p><img src="https://www.evernote.com/shard/s77/sh/f0e52914-41be-436a-a278-a8b947e10136/531945eba0426e888dc1eccc6d66156b/res/57054967-d0d3-421d-9c77-fc29957048be/skitch.png" alt="Reactor Pattern" /></p>

<p>In javascript, function can be passed as first class object,
so the code on node.js is heavily using callback and event to make efficient async I/O.</p>

<p>example a db query:</p>

<pre><code>db.posts.find(function(err, posts){
  console.log(posts);
});
</code></pre>

<p>could pass a function as callback to event loop, trigger it when the data is available.
and process can handle other tasks during response.</p>

<p>Also, the process.nextTick can also pass function to event loop, execute the function when the process is avaliable for task.</p>

<pre><code>//Blocked:

// some time consuming task
for(var i=0;i &lt; 10000000000; i++){}
console.log('done');

console.log('return')
//&gt;&gt; done
//&gt;&gt; return
</code></pre>

<p>&ndash;</p>

<pre><code>//Async:

process.nextTick(function(){
  // some time consuming task
  for(var i=0;i &lt; 10000000000; i++){}
  console.log('done');
});

console.log('return')
//&gt;&gt; return
//&gt;&gt; done
</code></pre>

<h2>reference</h2>

<ul>
<li><a href="http://truthabouteventloops.com/">The truth about event loops online masterclass</a></li>
<li><a href="http://howtonode.org/61f361ddb1696aee4afedaf356430cdd768b1d73/understanding-process-next-tick">Understanding process.nextTick()</a></li>
<li><a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">Understanding the node.js event loop</a></li>
<li><a href="http://fred-zone.blogspot.com/2012/09/glib-main-event-loop-nodejs-libuv.html">Integration of GLib Main Event Loop and Node.js (chinese) </a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jimmy Chao</span></span>

      








  


<time datetime="2013-01-09T18:02:00-05:00" pubdate data-updated="true">Jan 9<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/categories/node-dot-js/'>node.js</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://neethack.com/2013/01/understand-event-loops/" data-via="jimchaos" data-counturl="http://neethack.com/2013/01/understand-event-loops/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/12/review-2012/" title="Previous Post: Review of 2012">&laquo; Review of 2012</a>
      
      
        <a class="basic-alignment right" href="/2013/01/express-bigpipe-experiment/" title="Next Post: express bigpipe experiment">express bigpipe experiment &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="about">
  <h1>About Me</h1>
  <div class="avator">
    <img src="/images/JimmyChao.jpg" width="85" alt="Jimchao"/>
  </div>
  <div class="bio clear">
    <p>
      Jimmy Chao, A programmer, newbie hacker and web developer live in New York.
      You can contact me at daizenga[at]gmail.com. Or follow my code at 
      <a href="https://github.com/Rafe">Github</a>.
    </p>
  </div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/04/source-code-odyssey-amazon-aws-sdk/">Source Code Odyssey - Amazon Aws Sdk</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/10-javascript-interview-questions-my-version/">10 Javascript Interview Questions (My Version)</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/announcing-code-warrior/">Announcing Code-Warrior</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/bacon-dot-js-for-dummies/">Bacon.js for Dummies</a>
      </li>
    
      <li class="post">
        <a href="/2013/01/express-bigpipe-experiment/">Express Bigpipe Experiment</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jimchaos", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jimchaos" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jimchaos</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jimmy Chao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'neethack';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://neethack.com/2013/01/understand-event-loops/';
        var disqus_url = 'http://neethack.com/2013/01/understand-event-loops/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
