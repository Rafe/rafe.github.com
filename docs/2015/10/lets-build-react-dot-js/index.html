<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Let&#39;s build react.js | Neethack</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="Neethack">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
            
            <h1 class="blog-title"><a href="http://neethack.com">Neethack</a></h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>

  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2015-10-03T16:11:00.000Z" itemprop="datePublished">
          2015-10-03
      </time>
    
    
    | 
    <a href='/tags/javascript/'>javascript</a>
    
    
</span>
    <h1 class="post-title">Let's build react.js</h1>
    <section class="post-content">
      <p>Recently React is growing to become the de facto standard for web components. And it is also pretty straight forward to learn and use React.</p>
<p>I recommand to start with the <a href="https://facebook.github.io/react/" target="_blank" rel="noopener">official website</a> for documentations, also some examples on <a href="https://github.com/facebook/react/tree/master/examples" target="_blank" rel="noopener">github</a> and <a href="http://todomvc.com/examples/react" target="_blank" rel="noopener">Todomvc</a></p>
<p>However, for people already know how to write React, they might still wondering why React is built in a certain way, like React DOM, state, how React update and manipulate the DOM elements.</p>
<p>For those who are curious, this article is going to rebuild React from scratch and create a workable basic React-like framework, by going through the logics in React source code. I hope you can understand how React works after reading this post.</p>
<a id="more"></a>
<p>I recommand you can also checkout the <a href="https://github.com/Rafe/build-react-js" target="_blank" rel="noopener">code example</a> from github, each section is tagged by step 1-9, you can follow the code example to see how the code evolves with test cases.</p>
<h2 id="Let’s-write-React-component"><a href="#Let’s-write-React-component" class="headerlink" title="Let’s write React component!"></a>Let’s write React component!</h2><p>First, let’s create a simple react example:</p>
<iframe scrolling="no" width="100%" height="300" src="//jsfiddle.net/a81h610a/embedded/result,js,html/light" frameborder="0" allowfullscreen></iframe>
<p>In this component, We create the virtual DOM with ReactDOM but not jsx, render the DOM into container, and handle a click event to update the text and state with current timestamp.</p>
<p>Right now, we are going to take out the React framework, and write some code to make this work.</p>
<p>So… <em>Let’s Build React.js!!</em> (React.jsを作ってみましょう!!)</p>
<h2 id="Let’s-build-React-Element"><a href="#Let’s-build-React-Element" class="headerlink" title="Let’s build React Element!"></a>Let’s build React Element!</h2><p>Before building element, we need to understand the difference between React Element and React Component</p>
<p>React Element is data. Includes content type, property and child elements. Content type includes React DOM or React Class, React DOM is usually what we can find in render() method, React Class is the custom class that we wrote for application logic.</p>
<p>React Component is an instance. It contains element, render React DOM element to html, handle events, manage state and update DOM when state changes.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ReactElement = <span class="function"><span class="keyword">function</span>(<span class="params">type, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.type = type</span><br><span class="line">  <span class="keyword">this</span>.props = props</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> createElement = <span class="function"><span class="keyword">function</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> props = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">    props[propName] = config[propName]</span><br><span class="line">  &#125;</span><br><span class="line">  props.children = children</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactElement(type, props)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We create a simple ReactElement that holds the element type and properties. Also a createElement method that creates element by the type, properties and children.</p>
<p>With this createElement method, we can start to build ReactDOM.</p>
<h2 id="Let’s-build-React-DOM"><a href="#Let’s-build-React-DOM" class="headerlink" title="Let’s build React DOM!"></a>Let’s build React DOM!</h2><p>React DOM is a ReactElement with tag name as type, for example, a div element has ‘div’ as element type. We can create a DOM factory using javascript’s bind method:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DOM = &#123;&#125;;</span><br><span class="line">[<span class="string">'div'</span>, <span class="string">'a'</span>, <span class="string">'h1'</span>, <span class="string">'p'</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  DOM[type] = createElement.bind(<span class="literal">null</span>, type)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> React = &#123;</span><br><span class="line">  createElement: createElement,</span><br><span class="line">  DOM: DOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With React.DOM, we can build DOM tree with those factory methods:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DOM.div(<span class="literal">null</span>, [</span><br><span class="line">  DOM.h1(&#123; <span class="attr">className</span>: <span class="string">'title'</span>&#125;, <span class="string">'This is title'</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;div&gt;</span></span><br><span class="line"><span class="comment">//   &lt;h1 class="title"&gt;This is title&lt;/h1&gt;</span></span><br><span class="line"><span class="comment">// &lt;/div&gt;</span></span><br></pre></td></tr></table></figure>
<p>React DOM is the virtual DOM that represent the structure of DOM elements, because of the Virtual DOM, React can update only neccessary part when the structure or data changed on application.</p>
<p>Next we will create React Components to manage those Virtual DOM.</p>
<h2 id="Let’s-build-React-Component"><a href="#Let’s-build-React-Component" class="headerlink" title="Let’s build React Component!"></a>Let’s build React Component!</h2><p>React has 3 kinds of Components (basically) :</p>
<ul>
<li>TextComponent: render text content.</li>
<li>DOMComponent: render tag and it’s child elements.</li>
<li>CompositeComponent: custom react component with React Class, which includes all application logics. It is the component we saw in example.</li>
</ul>
<p>Each kind of component holds different element. A factory method ‘instantiateReactComponent’ will take element and create component by element types:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ReactDOMTextComponent = <span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._currentElement = text</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ReactCompositeComponent = <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._currentElement = element</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ReactDOMComponent = <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._currentElement = element</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> node === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> node.type === <span class="string">'string'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMComponent(node)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> node.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ReactCompositeComponent(node)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> node === <span class="string">'string'</span> || <span class="keyword">typeof</span> node === <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMTextComponent(node)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Let’s-create-React-Class"><a href="#Let’s-create-React-Class" class="headerlink" title="Let’s create React Class!"></a>Let’s create React Class!</h2><p>Class is the building block for React. A class define an interface for CompositeComponent to interact with application logics.<br>includes methods like <code>render</code>, <code>setState</code>, <code>render</code>, <code>getInitialState</code> and other custom methods. Also holds the state of the component.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClass</span>(<span class="params">spec</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Constructor = <span class="function"><span class="keyword">function</span>(<span class="params">props, updater</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.props = props</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.getInitialState ? <span class="keyword">this</span>.getInitialState() : <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.updater = updater</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set state and trigger update</span></span><br><span class="line">    <span class="keyword">this</span>.setState = <span class="function"><span class="keyword">function</span>(<span class="params">states</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (name <span class="keyword">in</span> states) &#123;</span><br><span class="line">        self.state[name] = states[name]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      self.updater.receiveComponent(self.render())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Constructor.prototype = spec</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Constructor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In here, <code>createClass</code> method returns constructor function for class, includes get initial states and set setState method, also inherit methods from spec object.</p>
<p>The class instance will be created as ReactCompositeComponent when it got instantiated by <code>React.render()</code> method.</p>
<p>Also, the class takes an updater as attribute, which is a ReactUpdateQueue object in Real React that quque DOM update actions, detect difference and update DOM.</p>
<p>After we have class, elements and components, we can start to implement ‘mount’ function on component, which creates rendered element for React to mount on container.</p>
<h2 id="Let’s-mount-React-Component"><a href="#Let’s-mount-React-Component" class="headerlink" title="Let’s mount React Component!"></a>Let’s mount React Component!</h2><p>For text component, mount method is simple:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMTextComponent.prototype.mountComponent = <span class="function"><span class="keyword">function</span>(<span class="params">rootID</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._rootID = rootID</span><br><span class="line">  <span class="keyword">return</span> (<span class="string">'&lt;span data-reactid="'</span> + rootID + <span class="string">'"&gt;'</span> + <span class="keyword">this</span>._currentElement + <span class="string">'&lt;/span&gt;'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We wrap the content with <code>&lt;span&gt;</code> tag for text element, put rootID as a data attribute <code>data-reactid</code> which will be pretty important when we try to update it.</p>
<p>For composite element, we initialize the element class, call <code>render()</code> to get DOM tree, than mount the returned DOM.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ReactCompositeComponent.prototype.mountComponent = <span class="function"><span class="keyword">function</span>(<span class="params">rootID</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._rootID = rootID</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> instance = <span class="keyword">new</span> <span class="keyword">this</span>._currentElement.type(<span class="keyword">this</span>._currentElement.props, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> renderedElement = instance.render()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._renderedComponent = instantiateReactComponent(renderedElement)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._renderedComponent.mountComponent(rootID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mounting the DOM component is a complex one. First we generate element tag, attach property like class name, then iterate all child elements, instantiate and mount child components and pass along react ID to keep track the index of elements.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMComponent.prototype.mountComponent = <span class="function"><span class="keyword">function</span>(<span class="params">rootID</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._rootID = rootID</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> props = <span class="keyword">this</span>._currentElement.props</span><br><span class="line"></span><br><span class="line">  <span class="comment">//creates tag and add attributes</span></span><br><span class="line">  <span class="keyword">var</span> tagOpen = <span class="string">'&lt;'</span> +</span><br><span class="line">    <span class="keyword">this</span>._currentElement.type +</span><br><span class="line">    <span class="keyword">this</span>.createMarkupForStyles(props) +</span><br><span class="line">    <span class="string">' data-reactid="'</span> + <span class="keyword">this</span>._rootID + <span class="string">'"'</span> +</span><br><span class="line">    <span class="string">'&gt;'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//creates close tag</span></span><br><span class="line">  <span class="keyword">var</span> tagClose = <span class="string">'&lt;/'</span> + <span class="keyword">this</span>._currentElement.type + <span class="string">'&gt;'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//iterate through child elements</span></span><br><span class="line">  <span class="keyword">if</span>(props.children) &#123;</span><br><span class="line">    <span class="comment">// instantiate all the child components</span></span><br><span class="line">    <span class="keyword">this</span>._renderedComponents = props.children.map(<span class="function"><span class="keyword">function</span>(<span class="params">element</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> instantiateReactComponent(element)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// render child components, passing rootID to keep track element position</span></span><br><span class="line">    <span class="comment">// ex: reactid 0.1.2 means it is at the third layer from top of the container,</span></span><br><span class="line">    <span class="comment">// and is third element from it's parent</span></span><br><span class="line">    <span class="keyword">var</span> subIndex = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> tagContent = <span class="keyword">this</span>._renderedComponents.map(<span class="function"><span class="keyword">function</span>(<span class="params">component</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> nextID = rootID + <span class="string">'.'</span> + subIndex++</span><br><span class="line">      <span class="keyword">return</span> component.mountComponent(nextID)</span><br><span class="line">    &#125;).join(<span class="string">''</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> tagContent = <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tagOpen + tagContent + tagClose</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMComponent.prototype.createMarkupForStyles = <span class="function"><span class="keyword">function</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(props.className) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' class="'</span> + props.className + <span class="string">'"'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And <code>mountComponent</code> method returns rendered html from virtual DOM.</p>
<h2 id="Let’s-render-React-Component"><a href="#Let’s-render-React-Component" class="headerlink" title="Let’s render React Component!"></a>Let’s render React Component!</h2><p>After we get all component rendered, we can put generated DOM onto the browser by calling <code>React.render</code> method.</p>
<p>In render method we take the top level element, create components, render and mount html to container.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> topComponent = instantiateReactComponent(element)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get initial reactid, usually is '.0'</span></span><br><span class="line">  <span class="keyword">var</span> reactRootID = registerComponent(topComponent, container)</span><br><span class="line"></span><br><span class="line">  container.innerHTML = topComponent.mountComponent(reactRootID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in example:</span></span><br><span class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">React.render(</span><br><span class="line">  React.createElement(App, &#123; <span class="attr">start</span>: start &#125;),</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Now we have the rendered components display on screen, next step is to handle update and events.</p>
<h2 id="Let’s-getNode-by-ReactID"><a href="#Let’s-getNode-by-ReactID" class="headerlink" title="Let’s getNode by ReactID!"></a>Let’s getNode by ReactID!</h2><p>Before we go to next step, we need to understand how ReactID works.</p>
<p><code>data-reactid</code> is a custom data attribute that exists on every react generated DOM elements. usually in the form of ‘.0.1.2’. The dot is seperator, and number is the index of the element under parent</p>
<p>For example:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Test1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Test2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Test3<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>We set the article element with reactid .0, the next 2 div will inherit parant id .0 and have the subfix to present it’s index.<br>the first div under article element will have id .0.0, second div will have id .0.1. So the element Test3 will have id .0.1.2, which means is on the second layer from top element, 2nd element on first layer and 3rd element on second layer.</p>
<p>As the example with reactid:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">data-reactid</span>=<span class="string">".0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-reactid</span>=<span class="string">".0.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-reactid</span>=<span class="string">".0.1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">data-reactid</span>=<span class="string">".0.1.0"</span>&gt;</span>Test1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">data-reactid</span>=<span class="string">".0.1.1"</span>&gt;</span>Test2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">data-reactid</span>=<span class="string">".0.1.2"</span>&gt;</span>Test3<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>But what are those id for? React component actually does not hold the reference of generated DOM, so when the component state changed, we need to find the DOM element by <code>getNode</code> function with ReactID.</p>
<p>So let’s implement the getNode function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNode</span>(<span class="params">targetID</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// get the array of ids</span></span><br><span class="line">  <span class="keyword">var</span> sequenceID = targetID.split(<span class="string">'.'</span>)</span><br><span class="line">  sequenceID.shift()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the top level element, which registered when you call render at top level.</span></span><br><span class="line">  <span class="keyword">var</span> child = containersByReactRootID[targetID.slice(<span class="number">0</span>, <span class="number">2</span>)]</span><br><span class="line">  <span class="keyword">while</span>(child) &#123;</span><br><span class="line">    <span class="keyword">var</span> id = child.getAttribute(<span class="string">'data-reactid'</span>)</span><br><span class="line">    <span class="keyword">if</span> (id === targetID) &#123;</span><br><span class="line">      <span class="keyword">return</span> child</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(child.children)&#123;</span><br><span class="line">      <span class="comment">// get the child element by index, with HTML DOM children property</span></span><br><span class="line">      child = child.children[sequenceID.shift()]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      child = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the <code>getNode</code> function, the component can link to the mounted DOM element, update and detect event by reactid.</p>
<h2 id="Let’s-capture-event"><a href="#Let’s-capture-event" class="headerlink" title="Let’s capture event!"></a>Let’s capture event!</h2><p>So let’s talk about event</p>
<p><img src="react_event.png" alt="Event"></p>
<p>This is the architecture for React events. Basicaly react capture the bubbled event on top level, get the reactid from event target to identify which event listener to call.<br>This a a centralize structure to handle events. So there is no event attached to child DOM element, all listener are attached at top level. So we react update, it does not needs to keep tracks of event listeners.<br>And the EventPluginHub allow plugin to handle all propagated events.</p>
<p>So let’s start with ReactEventEmitter:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ReactEventEmitter = &#123;</span><br><span class="line">  listenerBank: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// put listener to listener bank, takes id, event name and listener function</span></span><br><span class="line">  putListener: <span class="function"><span class="keyword">function</span> <span class="title">putListener</span>(<span class="params">id, registrationName, listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bankForRegistrationName =</span><br><span class="line">      <span class="keyword">this</span>.listenerBank[registrationName] || (<span class="keyword">this</span>.listenerBank[registrationName] = &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    bankForRegistrationName[id] = listener</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  getListener: <span class="function"><span class="keyword">function</span> <span class="title">getListener</span>(<span class="params">id, registrationName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.listenerBank[registrationName][id]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add an event dispatcher on top level element</span></span><br><span class="line">  trapBubbledEvent: <span class="function"><span class="keyword">function</span> <span class="title">trapBubbledEvent</span>(<span class="params">topLevelEventType, element</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// handle different event name</span></span><br><span class="line">    <span class="keyword">var</span> eventMap = &#123;</span><br><span class="line">      <span class="string">'onClick'</span>: <span class="string">'click'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> baseEventType = eventMap[topLevelEventType]</span><br><span class="line">    element.addEventListener(baseEventType, <span class="keyword">this</span>.dispatchEvent.bind(<span class="keyword">this</span>, topLevelEventType))</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// call registered event listener by react id and event name</span></span><br><span class="line">  dispatchEvent: <span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params">eventType, event</span>) </span>&#123;</span><br><span class="line">    event.preventDefault()</span><br><span class="line">    <span class="keyword">var</span> id = event.target.getAttribute(<span class="string">'data-reactid'</span>)</span><br><span class="line">    <span class="keyword">var</span> listener = <span class="keyword">this</span>.getListener(id, eventType)</span><br><span class="line">    <span class="keyword">if</span>(listener) &#123;</span><br><span class="line">      listener(event)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a simplified version of event emitter, we can add the hook to React.render function to trap event at top level:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> topComponent = instantiateReactComponent(element)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> reactRootID = registerComponent(topComponent, container)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// trap onClick event on top level</span></span><br><span class="line">  ReactEventEmitter.trapBubbledEvent(<span class="string">'onClick'</span>, container)</span><br><span class="line"></span><br><span class="line">  container.innerHTML = topComponent.mountComponent(reactRootID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this centralize event structure, React can manage all event listeners at one place, allow EventPlugin to plug and handle events.</p>
<h2 id="Let’s-update-React-Component"><a href="#Let’s-update-React-Component" class="headerlink" title="Let’s update React Component!"></a>Let’s update React Component!</h2><p>Update component is triggered by receiveComponent function, which take another element (data) and component will rerender with minimal DOM manipulation.<br>When the component receive element, it will compare the element is different or not, if it is different, rerender element and child elements, mount new DOM html to replace old html on browser DOM tree.</p>
<p>On text component, it is pretty simple, the component will compare new element, which is text. If text is changed, find Node by reactid, and update itself to new text.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMTextComponent.prototype.receiveComponent = <span class="function"><span class="keyword">function</span>(<span class="params">nextText</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>._currentElement != nextText) &#123;</span><br><span class="line">    <span class="keyword">var</span> node = React.getNode(<span class="keyword">this</span>._rootID)</span><br><span class="line">    node.innerHTML = nextText</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>On CompositeComponent, it will just call the child component with new element, which delegate to top level DOM component on virtual DOM.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReactCompositeComponent.prototype.receiveComponent = <span class="function"><span class="keyword">function</span>(<span class="params">nextElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._renderedComponent.receiveComponent(nextElement)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For DOM component, it will check all child components to see if any element changed, if so, then rerender the child elements.<br>DOM component compare element by shouldUpdateReactComponent function.<br>In this example we only compare the types, and only expect TextComponent to update itself. But in React it check the DOM structure change and remount the changed elements.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMComponent.prototype.receiveComponent = <span class="function"><span class="keyword">function</span>(<span class="params">nextElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._currentElement = nextElement</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> nextChildren = nextElement.props.children || []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// iternate through every children</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; nextChildren.length &gt; i; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> childElement = nextChildren[i]</span><br><span class="line">    <span class="keyword">var</span> childComponent = <span class="keyword">this</span>._renderedComponents[i]</span><br><span class="line">    <span class="comment">// check and update children</span></span><br><span class="line">    <span class="keyword">if</span> (shouldUpdateReactComponent(childComponent._currentElement, childElement)) &#123;</span><br><span class="line">      childComponent.receiveComponent(childElement)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldUpdateReactComponent</span>(<span class="params">prevElement, nextElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevElement != <span class="literal">null</span> &amp;&amp; nextElement != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> prevType = <span class="keyword">typeof</span> prevElement</span><br><span class="line">    <span class="keyword">var</span> nextType = <span class="keyword">typeof</span> nextElement</span><br><span class="line">    <span class="keyword">if</span> (prevType == <span class="string">'string'</span> || prevType === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextType === <span class="string">'string'</span> || nextType === <span class="string">'number'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        nextType === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">        prevElement.type === nextElement.type</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here is the finished example:</p>
<iframe scrolling="no" width="100%" height="300" src="//jsfiddle.net/05szbnbw/embedded/result,js,html/light" frameborder="0" allowfullscreen></iframe>
<p>This example simplified most of the complex logic in React, so if you are interested, go check the source code.</p>
<p>There is a lot of details about how React queue up DOM updates for performence. But I hope this example is enough to show the basics of how React works.</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Jimchao</h4>
    <p>A developer, hacker, traveler and boarder live in New York City. You can follow my code at  <a href="http://github.com/rafe">Github</a></p>
</section>

      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://neethack.com/2015/10/lets-build-react-dot-js/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://neethack.com/2015/10/lets-build-react-dot-js/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://neethack.com/2015/10/lets-build-react-dot-js/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2015/11/build-dropdown-list-with-rxjs/">
        ← Build dropdown list with RxJS
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2015/06/rails-abstraction-showcase/">
        Rails abstraction showcase →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Neethack</a> &copy; 2015 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>



<script type="text/javascript">
    var disqus_shortname = 'neethack';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
