<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Abstraction and essential complexity | Neethack</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="Neethack">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
            
            <h1 class="blog-title"><a href="http://neethack.com">Neethack</a></h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>

  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2020-10-04T18:50:20.000Z" itemprop="datePublished">
          2020-10-04
      </time>
    
    
    | 
    <a href='/tags/programming/'>programming</a>
    
    
</span>
    <h1 class="post-title">Abstraction and essential complexity</h1>
    <section class="post-content">
      <p><img src="top.png" alt="cover image"></p>
<blockquote>
<p>TLDR: Inline abstractions and simplify logic to write better code.</p>
</blockquote>
<p>Programmer’s work today is based on different levels of abstractions in the form of APIs and modules, they hide large amounts of implementation details so we can build features and products without understanding every detail. However, abstractions also increase the complexity of our code. Lots of time I struggle with overly complex code and try to fix those pieces by removing unnecessary abstractions. But how can we tell whether the abstraction is good or bad? How much abstraction in the code is too much? This article will be focusing on some of my views about abstraction and complexity in programming.</p>
<h2 id="Power-of-abstraction"><a href="#Power-of-abstraction" class="headerlink" title="Power of abstraction"></a>Power of abstraction</h2><p>Abstraction is the building block of programmers today, it frees the programmer from massive details of complexity, without it we will still be writing machine code, for example: </p>
<ul>
<li>Python and Ruby is an abstraction layer running on C interpreter</li>
<li>C is a layer on instruction set.</li>
<li>Rails provide multiple abstraction layers like MVC (model-view-controller), ORM (ActiveRecord, object-relation mapping)</li>
<li>React hide DOM updates into declarative components and state.</li>
</ul>
<p>In those examples, the abstractions provide a huge benefit by encapsulating details and providing a high-level syntax or API to let people understand and use them.</p>
<h2 id="Essential-and-accidental-complexity"><a href="#Essential-and-accidental-complexity" class="headerlink" title="Essential and accidental complexity"></a>Essential and accidental complexity</h2><p>Although abstraction is a really powerful tool, it also has its limitation.</p>
<p>In the paper “<a href="http://worrydream.com/refs/Brooks-NoSilverBullet.pdf" target="_blank" rel="noopener">No Silver Bullet</a>“, defines the software complexity in 2 parts. Essential complexity and accidental complexity.</p>
<p>Essential complexity is the complexity inherent in the problem domain. Including the mutation of state, condition, the order of procedure, and messaging. All other complexities from the language, framework, or stack are accidental. The line between those 2 complexities might vary, but basically, you can solve the problem with different languages, and different frameworks, but the essential - the algorithm and logic to solve the problem - can not be reduced. For example, you can write the quicksort in C, python, Haskell, or even pseudo-code. The essential complexity of quicksort still stays the same. Therefore no matter how much the technology of tooling improves, there is still no silver bullet to solve the essential complexity issue to increase the productivity of programmers.</p>
<h2 id="Problem-of-abstraction"><a href="#Problem-of-abstraction" class="headerlink" title="Problem of abstraction"></a>Problem of abstraction</h2><p>Abstraction is a useful tool to reduce accidental complexity, but it also has several drawbacks:</p>
<ol>
<li>It can not reduce essential complexity. </li>
</ol>
<p>Although abstraction can largely reduce accidental complexity, make the code closer to the problem domain by providing higher-level syntax and API. However, the problem domain still inherits the complexity from the real world. Abstraction can not make it simpler. </p>
<ol start="2">
<li>It increases accidental complexity.</li>
</ol>
<p>This is a tricky part because abstraction is not essential for solving the problem. Any extra abstractions are increasing accidental complexity. But then how does the abstraction decrease complexity? By enough usage of it. A higher-level abstraction can represent multiple lower-level concepts together. So with more usage, it can encapsulate more details and make the code focus on essential complexity but not accidental. So with the growth of the problem domain, the complexity of abstraction will grow like this: <img src="pic1.png" alt="pic1">. </p>
<p>At the beginning of the graph, it will increase more complexity. For example, we can create the acronym “ECAC” to represent those 2 types of complexity. If I only use this acronym once in this post, it only makes this more complicated because the acronym is not essential. However, if this article got widely accepted, we might be able to call our colleague “you should look at the ECAC for your code” Then it makes the conversation simpler.</p>
<ol start="3">
<li>It might be wrong or misleading.</li>
</ol>
<p>Abstractions are not essential, so in the worst case, they might not be correct and misleading. This graph shows how complexity grows with wrong abstractions. <img src="pic2.png" alt="pic2"></p>
<p>If an abstraction does not have enough usage to cover the extra complexity introduced. It only makes the code more complicated. Or the abstraction might not be able to successfully hide lower-level details, and users even have to bypass the abstraction. Both of those cases make the abstraction increase accidental complexity rather than decrease it.</p>
<h2 id="Reduce-complexity"><a href="#Reduce-complexity" class="headerlink" title="Reduce complexity"></a>Reduce complexity</h2><p>Then how can we properly reduce the complexity of our code? Here are a couple of suggestions:</p>
<ol>
<li>Make reducing essential complexity the priority</li>
</ol>
<p>Because, unlike abstractions, a better algorithm is basically, better.</p>
<p>The way I use to estimate is by inline most of the abstractions in our problem domain to see procedures, conditions, messaging, and state mutations. And try to make those steps simpler, like removing redundant steps, changing the order to remove conditions, and removing unnecessary states. </p>
<ol start="2">
<li>Always evaluate multiple solutions</li>
</ol>
<p>Sometimes it is really hard to evaluate whether the changes are worth it or not, Therefore evaluating multiple solutions is a good guideline. We can find what is essential in different solutions, And follow Occam’s Razor principle: the simplest solution usually is the best solution.</p>
<ol start="3">
<li>Reorganize, inline, and rename code</li>
</ol>
<p>With those methods, we can reduce extra abstractions and reduce accidental complexity, and also help you understand the logic and find a better algorithm.</p>
<ol start="4">
<li>Rule of three</li>
</ol>
<p>A basic rule to introduce abstraction is to wait until you have 3 usages. It might vary but that is the least case for the abstraction to be useful.</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Here I am going to reuse the example in Sandi Matz’s talk: <a href="https://youtu.be/XXi_FBrZQiU" target="_blank" rel="noopener">Polly want a message</a>, In this talk, Sandi explains how object-oriented and abstraction can simplify a project that read a file and print line numbers, here is the source:</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listing</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:filename</span>, <span class="symbol">:line_numbers</span>, <span class="symbol">:left_just</span>, <span class="symbol">:repository</span>, <span class="symbol">:tag</span>, <span class="symbol">:git</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">filename:</span>, <span class="symbol">line_numbers:</span> <span class="literal">nil</span>, <span class="symbol">left_just:</span> <span class="literal">nil</span>, <span class="symbol">repository:</span> <span class="literal">nil</span>, <span class="symbol">tag:</span> <span class="literal">nil</span>, <span class="symbol">git_cmd:</span> <span class="literal">nil</span>)</span></span></span><br><span class="line">    @filename = filename</span><br><span class="line">    @line_numbers = line_numbers</span><br><span class="line">    @repository = repository</span><br><span class="line">    @left_just = left_just</span><br><span class="line">    @tag = tag</span><br><span class="line">    @git_cmd = git_cmd</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">    all_lines = <span class="keyword">if</span> git_cmd</span><br><span class="line">                  git_lines</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  file_lines</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    subset = <span class="keyword">if</span> line_numbers</span><br><span class="line">               lines_to_print(all_lines)</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">               all_lines</span><br><span class="line">             <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> left_just</span><br><span class="line">      <span class="keyword">return</span> justify(subset)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    subset</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">git_lines</span></span></span><br><span class="line">    git_cmd.repository = repository</span><br><span class="line">    git_cmd.tagname = tag</span><br><span class="line">    git_cmd.filename = filename</span><br><span class="line">    git_cmd.show.split(<span class="string">"\n"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">file_lines</span></span></span><br><span class="line">    File.read(filename).split(<span class="string">"\n"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lines_to_print</span><span class="params">(all_lines)</span></span></span><br><span class="line">    specs = line_numbers.gsub(<span class="regexp">/['|']/</span>, <span class="string">''</span>).gsub(<span class="regexp">/ /</span>, <span class="string">''</span>).split(<span class="string">','</span>)</span><br><span class="line">    specs.collect <span class="keyword">do</span> <span class="params">|spec|</span></span><br><span class="line">      <span class="keyword">if</span> spec.<span class="keyword">include</span>?(<span class="string">'#'</span>)</span><br><span class="line">        num_spaces = spec.delete(<span class="string">'#'</span>).to_i</span><br><span class="line">        (<span class="string">' '</span> * num_spaces) + <span class="string">'# ...'</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        edges = spec.split(<span class="string">'-'</span>).collect(&amp;<span class="symbol">:to_i</span>)</span><br><span class="line">        individual_numbers = (edges.min.to_i..edges.max.to_i).to_a</span><br><span class="line">        individual_numbers.collect &#123; <span class="params">|i|</span> all_lines[i - <span class="number">1</span>] &#125;.compact</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.flatten.compact</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">justify</span><span class="params">(lines)</span></span></span><br><span class="line">    lines.map &#123; <span class="params">|line|</span> line.slice(num_leading_space_to_remove(lines)..-<span class="number">1</span>) <span class="params">||</span> <span class="string">''</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">num_leading_space_to_remove</span><span class="params">(lines)</span></span></span><br><span class="line">    @num <span class="params">||</span>= </span><br><span class="line">      lines.reduce(<span class="number">999_999</span>) &#123; <span class="params">|current_min, line|</span></span><br><span class="line">        line.empty? ? current_min : [current_min, num_leading_spaces(line)].min</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">num_leading_spaces</span><span class="params">(line)</span></span></span><br><span class="line">    line[<span class="regexp">/\A */</span>].size</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GitCmd</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:repository</span>, <span class="symbol">:tagname</span>, <span class="symbol">:filename</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">    <span class="string">`git <span class="subst">#&#123;git_dir&#125;</span> show <span class="subst">#&#123;tagname&#125;</span>:<span class="subst">#&#123;filename&#125;</span>`</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">git_dir</span></span></span><br><span class="line">    <span class="string">%(--git-dir="<span class="subst">#&#123;repository&#125;</span>")</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>And Sandi shows how to use object-oriented to refactor the previous source, I will ignore the progress and only show the result here. It is to better follow the talk for details:</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listing</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:source</span>, <span class="symbol">:subsetter</span>, <span class="symbol">:justifier</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">source:</span>, <span class="symbol">subsetter:</span>, <span class="symbol">justifier:</span>)</span></span></span><br><span class="line">    @source = source</span><br><span class="line">    @subsetter = subsetter</span><br><span class="line">    @justifier = justifier</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">    justifier.justify(subsetter.lines(source.lines))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Source</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line">    <span class="keyword">attr_reader</span> <span class="symbol">:filename</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">filename:</span>)</span></span></span><br><span class="line">      @filename = filename</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">      <span class="symbol">:</span><span class="symbol">:File</span>.read(filename).split(<span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">GitTag</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">git_cmd</span></span></span><br><span class="line">      GitCmd.new</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">attr_reader</span> <span class="symbol">:filename</span>, <span class="symbol">:tagname</span>, <span class="symbol">:repository</span>, <span class="symbol">:git_cmd</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">filename:</span>, <span class="symbol">repository:</span>, <span class="symbol">tag:</span>, <span class="symbol">git_cmd:</span> <span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">git_cmd</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="params">      @git_cmd = git_cmd</span></span></span><br><span class="line"><span class="function"><span class="params">      git_cmd.repository = repository</span></span></span><br><span class="line"><span class="function"><span class="params">      git_cmd.tagname = tag</span></span></span><br><span class="line"><span class="function"><span class="params">      git_cmd.filename = filename</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">end</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span></span></span><br><span class="line"><span class="function"><span class="params">      git_cmd.show.split(<span class="string">"\n"</span>)</span></span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">GitCmd</span></span></span><br><span class="line">    <span class="keyword">attr_accessor</span> <span class="symbol">:repository</span>, <span class="symbol">:tagname</span>, <span class="symbol">:filename</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">      <span class="string">`git <span class="subst">#&#123;git_dir&#125;</span> show <span class="subst">#&#123;tagname&#125;</span>:<span class="subst">#&#123;filename&#125;</span>`</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">git_dir</span></span></span><br><span class="line">      <span class="string">%Q[--git-dir="<span class="subst">#&#123;repository&#125;</span>"]</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Subset</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Everything</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span><span class="params">(everything)</span></span></span><br><span class="line">      everything</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">LineNumber</span></span></span><br><span class="line">    <span class="keyword">attr_reader</span> <span class="symbol">:line_numbers</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">line_numbers:</span>)</span></span></span><br><span class="line">      @line_numbers = line_numbers</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span><span class="params">(possibilities)</span></span></span><br><span class="line">      clump_specs.collect &#123; <span class="params">|spec|</span> clump_for(spec, possibilities) &#125;.flatten.compact</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clump_specs</span></span></span><br><span class="line">      line_numbers.gsub(<span class="regexp">/['|']/</span>, <span class="string">''</span>).gsub(<span class="regexp">/ /</span>, <span class="string">''</span>).split(<span class="string">','</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clump_for</span><span class="params">(spec, possibilities)</span></span></span><br><span class="line">      Clump.lines(<span class="symbol">spec:</span> spec, <span class="symbol">possibilties:</span> possibilities)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Clump</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">lines</span><span class="params">(<span class="symbol">spec:</span>, <span class="symbol">possibilities:</span> [])</span></span></span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">for</span>(<span class="symbol">spec:</span> spec, <span class="symbol">possibilities:</span> possibilities).lines</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">for</span><span class="params">(<span class="symbol">spec:</span>, <span class="symbol">possibilities:</span> [])</span></span></span><br><span class="line">    <span class="keyword">if</span> spec.<span class="keyword">include</span>?(<span class="string">'#'</span>)</span><br><span class="line">      Clump::Comment</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      Clump::LineNumber</span><br><span class="line">    <span class="keyword">end</span>.new(<span class="symbol">spec:</span> spec, <span class="symbol">input:</span> possibilities)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:spec</span>, <span class="symbol">:input</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">spec:</span>, <span class="symbol">input:</span> [])</span></span></span><br><span class="line">    @spec = spec</span><br><span class="line">    @input = input</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">LineNumber</span> &lt; Clump</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">      expand_clump(spec).contact &#123; <span class="params">|i|</span> input[i - <span class="number">1</span>] &#125;.compact</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">expand_clump</span><span class="params">(spec)</span></span></span><br><span class="line">      edges = spec.split(<span class="string">'-'</span>).collect(&amp;<span class="symbol">:to_i</span>)</span><br><span class="line">      (edges.min.to_i..edges.max.to_i).to_a</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> &lt; Clump</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">      num_spaces = spec.delete(<span class="string">'#'</span>).to_i</span><br><span class="line">      (<span class="string">' '</span> * num_spaces) + <span class="string">'# ...'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Justification</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">None</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">justify</span><span class="params">(lines)</span></span></span><br><span class="line">      lines</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">BlockLeft</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">justify</span><span class="params">(lines)</span></span></span><br><span class="line">      new(lines).justify</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">attr_reader</span> <span class="symbol">:lines</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(lines)</span></span></span><br><span class="line">      @lines = lines</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">justify</span></span></span><br><span class="line">      lines.map &#123; <span class="params">|line|</span> line.slice(num_leading_space_to_remove(lines)..-<span class="number">1</span>) <span class="params">||</span> <span class="string">''</span> &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">num_leading_space_to_remove</span><span class="params">(lines)</span></span></span><br><span class="line">      @num_leading_space_to_remove <span class="params">||</span>= lines.reduce(<span class="number">999_999</span>) <span class="keyword">do</span> <span class="params">|current_min, line|</span></span><br><span class="line">        line.empty? ? current_min : [current_min, num_leading_spaces(line)].min</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">num_leading_spaces</span><span class="params">(line)</span></span></span><br><span class="line">      line[<span class="regexp">/\A */</span>].size</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Comparing those 2 versions, I think people have different opinions about them. Some say the object-oriented version is way more complicated than the original one. Others say it provides more flexibility and encapsulates complex logic in objects. But how do we know which way is better? Here comes the essential complexity. When we compare the original code and refactored code. They are essentially doing the same things, with no duplicated code removed from refactoring, but only introducing more abstractions, which increase accidental complexity. So these refactor make the code more complicated in exchange for object-oriented and flexibility, but the goal of refactoring is not to make the code more object-oriented, but to reduce complexity, therefore this refactor is a failure from the complexity standpoint. </p>
<p>But from the standpoint of object-oriented, it is better because it fits all perspectives of object-oriented. Single responsibility, Open-closed, Liskov substitution, Interface segregation, Dependency Injection. But object-oriented is a programming method, not the goal of programming. Refactor to code like this is mistaking the methodology as a goal. And it will seem like a great refactor (done by top OO consultant!) until the next person comes in to try to modify this mud of objects.</p>
<p>So what is the alternative if refactoring into abstractions only makes things more complicated? Leave the code as it is?</p>
<p>The answer is no, we can still improve the original code, but instead of thinking in objects, we have to think in algorithms and logic. We need to find places to reduce essential and accidental complexity. First, we need to find what is the problem in the original code? I think there are a couple of candidates for refactoring:</p>
<ol>
<li>Setup git_cmd object is not necessary.</li>
<li>Naming is confusing in <code>lines_to_print</code>, it introduced specs, edges, and individual numbers. Those variable names introduce more confusion about what they are doing.</li>
<li>Algorithm for justifying space is bad, it runs <code>reduce</code> with a large number which can be avoided by calling #min.</li>
</ol>
<p>So let’s try to solve them one by one</p>
<ul>
<li>For the git_cmd, we can easily inline it as a method</li>
<li>For the lines_to_print, we can rename specs to parsed_line_numbers, edges to range</li>
<li>For justify spaces, we can use <code>min</code> instead of calling <code>reduce</code></li>
<li>we can move the conditions check into methods to make the workflow looks better</li>
</ul>
<p>So the refactored version is:</p>
<figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listing</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:filename</span>, <span class="symbol">:line_numbers</span>, <span class="symbol">:left_just</span>, <span class="symbol">:repository</span>, <span class="symbol">:tag</span>, <span class="symbol">:git</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(<span class="symbol">filename:</span>, <span class="symbol">line_numbers:</span> <span class="literal">nil</span>, <span class="symbol">left_just:</span> <span class="literal">nil</span>, <span class="symbol">repository:</span> <span class="literal">nil</span>, <span class="symbol">tag:</span> <span class="literal">nil</span>, <span class="symbol">git:</span> <span class="literal">false</span>)</span></span></span><br><span class="line">    @filename = filename</span><br><span class="line">    @line_numbers = line_numbers</span><br><span class="line">    @repository = repository</span><br><span class="line">    @left_just = left_just</span><br><span class="line">    @tag = tag</span><br><span class="line">    @git = git</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lines</span></span></span><br><span class="line">    justify_spaces(lines_to_print(read_lines))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">read_lines</span></span></span><br><span class="line">    <span class="keyword">if</span> git</span><br><span class="line">      <span class="string">`git --git-dir=<span class="subst">#&#123;repository&#125;</span> show <span class="subst">#&#123;tag&#125;</span>:<span class="subst">#&#123;filename&#125;</span>`</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      File.read(filename)</span><br><span class="line">    <span class="keyword">end</span>.split(<span class="string">"\n"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lines_to_print</span><span class="params">(lines)</span></span></span><br><span class="line">    <span class="keyword">return</span> all_lines <span class="keyword">unless</span> line_numbers</span><br><span class="line"></span><br><span class="line">    parsed_line_numbers = line_numbers.gsub(<span class="string">' '</span>, <span class="string">''</span>).split(<span class="string">','</span>)</span><br><span class="line">    parsed_line_numbers.collect <span class="keyword">do</span> <span class="params">|line_number|</span></span><br><span class="line">      <span class="keyword">if</span> line_number.<span class="keyword">include</span>?(<span class="string">'#'</span>)</span><br><span class="line">        spaces = <span class="string">' '</span> * line_number.delete(<span class="string">'#'</span>).to_i</span><br><span class="line">        <span class="string">"<span class="subst">#&#123;spaces&#125;</span># ..."</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        range = line_number.split(<span class="string">'-'</span>).collect &#123; <span class="params">|n|</span> n.to_i - <span class="number">1</span> &#125;</span><br><span class="line">        all_lines.slice(*range)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.flatten.compact</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">justify_spaces</span><span class="params">(all_lines)</span></span></span><br><span class="line">    <span class="keyword">return</span> all_lines <span class="keyword">unless</span> just_left</span><br><span class="line"></span><br><span class="line">    leading_spaces_to_remove = all_lines.reject(&amp;<span class="symbol">:empty?</span>).min <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">      line[<span class="regexp">/\A */</span>].size</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    all_lines.map <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">      line.slice(leading_spaces_to_remove..-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Generally, I think this version is better than the previous two versions. But how do we know which one is better? After all, this refactor doesn’t change code much, it is still doing a lot of things in one object, and doesn’t fit the SOLID principle. but compared to the original code, the essential and accidental complexity both decreased, mainly by improving justifying the logic and some minor improvement for <code>lines_to_print</code> and <code>read_lines</code>. Make the program size from 86 lines to 53 lines. So if we want to introduce abstractions at this point, the code will still be simpler. We can of course introduce more abstractions, but abstractions also increase accidental complexity, <code>read_lines</code>, <code>lines_to_print</code> and <code>justify_spaces</code> can all be extracted to separate modules, but without any usage, those abstractions can not reduce complexity, therefore it is better to wait until there are other usages in the codebase.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>When writing code, we need to carefully estimate the essential complexity and accidental complexity, and understand the goal is to reduce them, but not implement any patterns or abstractions themselves. When we see the opportunity to introduce abstractions, start from a simple one and make sure there are enough usages. Also, be ready to remove it when it becomes unnecessary. Last but not least figure out how to reduce essential complexity and replace it with a better algorithm to solve the problem domain.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://medium.com/ni-tech-talk/caught-in-a-bad-abstraction-55bfe6634b83" target="_blank" rel="noopener">https://medium.com/ni-tech-talk/caught-in-a-bad-abstraction-55bfe6634b83</a></li>
<li><a href="https://en.wikipedia.org/wiki/Essential_complexity" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Essential_complexity</a></li>
<li><a href="http://worrydream.com/refs/Brooks-NoSilverBullet.pdf" target="_blank" rel="noopener">http://worrydream.com/refs/Brooks-NoSilverBullet.pdf</a></li>
<li><a href="https://www.youtube.com/watch?v=IRTfhkiAqPw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=IRTfhkiAqPw</a> object oriented programming is embarrassing</li>
<li><a href="https://www.youtube.com/watch?v=vG8WpLr6y_U&amp;list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&amp;index=16" target="_blank" rel="noopener">https://www.youtube.com/watch?v=vG8WpLr6y_U&amp;list=PLPxbbTqCLbGHPxZpw4xj_Wwg8-fdNxJRh&amp;index=16</a> lets program like it’s 1999 </li>
<li><a href="http://blog.spinthemoose.com/2012/12/17/solid-as-an-antipattern/" target="_blank" rel="noopener">http://blog.spinthemoose.com/2012/12/17/solid-as-an-antipattern/</a></li>
<li><a href="https://speakerdeck.com/tastapod/why-every-element-of-solid-is-wrong" target="_blank" rel="noopener">https://speakerdeck.com/tastapod/why-every-element-of-solid-is-wrong</a></li>
</ul>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Jimchao</h4>
    <p>A developer, hacker, traveler and boarder live in New York City. You can follow my code at  <a href="http://github.com/rafe">Github</a></p>
</section>

      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://neethack.com/2020/10/Abstraction-and-essential-complexity/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://neethack.com/2020/10/Abstraction-and-essential-complexity/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://neethack.com/2020/10/Abstraction-and-essential-complexity/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2020/11/apollo-reactive-store/">
        ← Announce apollo-reactive-store
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2020/08/Top-10-mistakes-senior-developers-make/">
        Top 10 mistakes senior developers make →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Neethack</a> &copy; 2015 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>



<script type="text/javascript">
    var disqus_shortname = 'neethack';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
