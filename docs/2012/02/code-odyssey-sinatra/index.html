<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Code Odyssey : Sinatra | Neethack</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="Neethack">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
            
            <h1 class="blog-title"><a href="http://neethack.com">Neethack</a></h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>

  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2012-02-22T05:09:00.000Z" itemprop="datePublished">
          2012-02-22
      </time>
    
    
    | 
    <a href='/tags/ruby/'>ruby</a>
    
    
</span>
    <h1 class="post-title">Code Odyssey : Sinatra</h1>
    <section class="post-content">
      <p>In 2012, I am planning to start contribute and participate more on opensource projects.<br>The target of this series is to read through the source of open source projects that I am interested with,<br>and explain the structure and interesting pieces that I found in the source.</p>
<h2 id="Sinatra"><a href="#Sinatra" class="headerlink" title="Sinatra"></a><a href="http://www.sinatrarb.com" target="_blank" rel="noopener">Sinatra</a></h2><p><a href="http://www.sinatrarb.com" target="_blank" rel="noopener">Sinatra</a> is a rack-base , lightweight web framework implemented in ruby.<br>Written and desinged by <a href="https://github.com/bmizerany" target="_blank" rel="noopener">Blake Mizerany</a>. Famous for it’s dsl syntax and simpliness.</p>
<a id="more"></a>
<h2 id="Source-structure"><a href="#Source-structure" class="headerlink" title="Source structure"></a>Source structure</h2><pre><code>examples/
lib/
  sinatra/
    base.rb   #all codes are in here
    main.rb   #Application class, extends Base class in base.rb
    showException.rb #output exception and trace message as Html error page
  sinatra.rb  
test/
Rakefile
Gemfile.gem
</code></pre><h2 id="base-rb"><a href="#base-rb" class="headerlink" title="base.rb"></a>base.rb</h2><p>Main Sinatra application, includes:</p>
<ol>
<li><p>Rack Module :<br>Implement Rack:Request and Rack:Response</p>
</li>
<li><p>Helper Module :<br>Helper methods that available in routes, filters and views ,<br>handle tasks like redirect, status code, url, html header, session, mime type, http stearming… etc </p>
</li>
<li><p>Template Module :<br>Handle multiple template engines using <a href="https://github.com/rtomayko/tilt" target="_blank" rel="noopener">tilt</a></p>
</li>
<li><p>Base class:<br>The main class that include all modules above. Handling routes and invoke correspond code blocks and filters.</p>
</li>
<li><p>Application class:<br>Inherit Base class, the run instance of Sinatra application.</p>
</li>
<li><p>Delegator module:<br>Delegate DSL methods in Top-level file to Sinatra Application. </p>
</li>
</ol>
<h2 id="main-rb"><a href="#main-rb" class="headerlink" title="main.rb"></a>main.rb</h2><p>Patch Sinatra::Application class, set the hooks to run application at exit and Parse option. Also it includes the delegator to send all methods on Top-level to application.</p>
<h2 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h2><p>Sinatra source seperate the declaration of external ,stdlib and project depedencies.<br>Which is pretty clean and easy to understand:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># external dependencies</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'rack'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'tilt'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"rack/protection"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stdlib dependencies</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'thread'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'time'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'uri'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># other files we need</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/showexceptions'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/version'</span></span><br></pre></td></tr></table></figure>
<h2 id="Delegator"><a href="#Delegator" class="headerlink" title="Delegator"></a>Delegator</h2><p>Delegator is an interesting part in Sinatra, since it creates a really simple API that user can just write method with HTTP verb in Top level file, without creating any class.<br>For example:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#myapp.rb</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra'</span></span><br><span class="line"></span><br><span class="line">get <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="string">'Hello world!'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Execute this file will run Sinatra application handle route “/“ with GET request.<br>But how do Sinatra do this?  </p>
<p>Take a look at the source of Delegator:<br><figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Sinatra delegation mixin. Mixing this module into an object causes all</span></span><br><span class="line"><span class="comment"># methods to be delegated to the Sinatra::Application class. Used primarily</span></span><br><span class="line"><span class="comment"># at the top-level.</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Delegator</span> <span class="comment">#:nodoc:</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">delegate</span><span class="params">(*methods)</span></span></span><br><span class="line">    methods.each <span class="keyword">do</span> <span class="params">|method_name|</span></span><br><span class="line">      define_method(method_name) <span class="keyword">do</span> <span class="params">|*args, &amp;block|</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>(*args, &amp;block) <span class="keyword">if</span> respond_to? method_name</span><br><span class="line">        Delegator.target.send(method_name, *args, &amp;block)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      private method_name</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  delegate <span class="symbol">:get</span>, <span class="symbol">:patch</span>, <span class="symbol">:put</span>, <span class="symbol">:post</span>, <span class="symbol">:delete</span>, <span class="symbol">:head</span>, <span class="symbol">:options</span>, <span class="symbol">:template</span>, <span class="symbol">:layout</span>,</span><br><span class="line">           <span class="symbol">:before</span>, <span class="symbol">:after</span>, <span class="symbol">:error</span>, <span class="symbol">:not_found</span>, <span class="symbol">:configure</span>, <span class="symbol">:set</span>, <span class="symbol">:mime_type</span>,</span><br><span class="line">           <span class="symbol">:enable</span>, <span class="symbol">:disable</span>, <span class="symbol">:use</span>, <span class="symbol">:development?</span>, <span class="symbol">:test?</span>, <span class="symbol">:production?</span>,</span><br><span class="line">           <span class="symbol">:helpers</span>, <span class="symbol">:settings</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="keyword">attr_accessor</span> <span class="symbol">:target</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.target = Application</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>First, if we want to delegate method to another class, we can include the methods in files :</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Delegator</span></span></span><br><span class="line">  <span class="keyword">self</span>.target = Application</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(*args,&amp;block)</span></span></span><br><span class="line">    target.get(*args, &amp;block)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> Delegator </span><br><span class="line"></span><br><span class="line"><span class="comment">#then we can call 'get' method in file and delegate to target </span></span><br><span class="line">get <span class="string">'/'</span> <span class="keyword">do</span> </span><br><span class="line">  <span class="string">"Hello delegator!!"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>But how would we do if we have lots of method to delegate? In Sinatra, it has lots of methods and Http verbs to be delegated. The code will be pretty ugly if we have to implement all these repeated methods.<br>The answer here is metaprogramming: We can use ruby’s ability of metaprogramming to create repeated methods in a few lines of code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Delegator</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">delegate</span><span class="params">(method_name)</span></span></span><br><span class="line">    define_method(method_name) <span class="keyword">do</span> <span class="params">|*args, &amp;block|</span></span><br><span class="line">      Delegator.target.send(method_name, *args, &amp;block)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    private method_name</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  delegate <span class="symbol">:get</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.target = Application</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In ruby, we can use “define_method” to create method programmically, and use “send(method_name, *args, &amp;block)” To call the target method by the method_name. This makes the code a lot cleaner in Sinatra</p>
<h2 id="Routes"><a href="#Routes" class="headerlink" title="Routes"></a>Routes</h2><p>In sinatra, after user call the dsl methods(like get, post) in file,<br>the HTTP verbs ,path and code block will be registered in application,<br>And will be executed when receiving matched request.</p>
<p>When the dsl method get called, the Application will generate a Proc with the name of<br>HttpVerb and path (like “get /“) save the Proc, url path (include the keys, pattern and conditions on paths, like “/:id” ) in @routes. </p>
<p>Here’s the simplify version of routes :</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="keyword">attr_reader</span> <span class="symbol">:routes</span> </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(path, options=&#123;&#125;, &amp;block)</span></span></span><br><span class="line">      route(<span class="string">"GET"</span>, path, options, &amp;block)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(verb, path, options, &amp;block)</span></span></span><br><span class="line">      @routes <span class="params">||</span>= &#123;&#125;</span><br><span class="line">      signature = compile!(verb, path, block, options)</span><br><span class="line">      @routes[verb] <span class="params">||</span>= []</span><br><span class="line">      @routes[verb] &lt;&lt; signature</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compile!</span><span class="params">(verb, path, block, options)</span></span></span><br><span class="line">      unbound_method = generate_method(<span class="string">"<span class="subst">#&#123;verb&#125;</span> <span class="subst">#&#123;path&#125;</span>"</span>,&amp;block)</span><br><span class="line"></span><br><span class="line">      [path, proc &#123;<span class="params">|base|</span> unbinded_method.bind(base).call() &#125; ]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_method</span><span class="params">(method_name, &amp;block)</span></span></span><br><span class="line">      define_method(method_name, &amp;block)</span><br><span class="line">      method = instance_method method_name</span><br><span class="line">      remove_method method_name</span><br><span class="line">      method</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">App.get <span class="string">"/"</span> <span class="keyword">do</span> </span><br><span class="line">  <span class="string">"Hello world"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">base = App.new</span><br><span class="line"></span><br><span class="line">App.routes[<span class="string">"GET"</span>][<span class="number">0</span>][<span class="number">1</span>].call(base)</span><br><span class="line"><span class="comment">#print:: "Hello world"</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In here, sinatra generates the code block as an <a href="http://www.ruby-doc.org/core-1.9.3/UnboundMethod.html" target="_blank" rel="noopener">unbound_method</a>, it is a kind of instance method that you can bind it to any other instance dynamically before call. Sinatra use this to bind Application instance with Proc on runtime. </p>
<p>##Route call</p>
<p>After register the code block, sinatra wait for request and invoke correspond routes to handle request.<br>The entry point of all request is the <a href="http://chneukirchen.org/blog/archive/2007/02/introducing-rack.html" target="_blank" rel="noopener">rack call interface</a>. All rack application must implement the interface.</p>
<p>Overall, the request execution stack is:<br>  call =&gt; call! =&gt; invoke =&gt; dispatch! =&gt; route! =&gt; route_eval</p>
<figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></span><br><span class="line">  dup.call!(env)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call!</span><span class="params">(env)</span></span></span><br><span class="line">  @env = env</span><br><span class="line">  @request = Request.new(env)</span><br><span class="line">  @response = Response.new </span><br><span class="line">  @params = indifferent_params(@request.params)</span><br><span class="line">  template_cache.clear <span class="keyword">if</span> settings.reload_templates</span><br><span class="line">  force_encoding(@params)</span><br><span class="line"></span><br><span class="line">  @response[<span class="string">'Content-Type'</span>] = <span class="literal">nil</span> </span><br><span class="line">  invoke &#123; dispatch!&#125;</span><br><span class="line">  invoke &#123; error_block!(response.status) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unless</span> @response[<span class="string">'Content-Type'</span>]</span><br><span class="line">    <span class="keyword">if</span> Array === body <span class="keyword">and</span> body[<span class="number">0</span>].respond_to? <span class="symbol">:content_type</span></span><br><span class="line">      content_type body[<span class="number">0</span>].content_type</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      content_type <span class="symbol">:html</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    @response.finish</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The code above is the first part of how Sinatra handle incoming requests.<br>First, as a Rack application, all request will invoke the call(env) function<br>Sinatra application will duplicate an instance, invoke the call!(env) on new instance (because HTTP is stateless)<br>in the call! function, sinatra will new the Rack::Request and Rack::Response object by env, than set the params.</p>
<p>After all object is set, it will start to invoke the routes by “invoke{ dispatch! }”, the result will be store<br>on @response, and return to user by call the @response.finish</p>
<figure class="highlight smali"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run the block with 'throw :halt' support and apply result to the response.</span></span><br><span class="line">def invoke</span><br><span class="line">  res = catch(:halt) &#123; yield &#125;</span><br><span class="line">  res = [res]<span class="built_in"> if </span>Fixnum === res<span class="built_in"> or </span>String === res</span><br><span class="line"> <span class="built_in"> if </span>Array === res<span class="built_in"> and </span>Fixnum === res.first</span><br><span class="line">    status(res.shift)</span><br><span class="line">    body(res.pop)</span><br><span class="line">    headers(*res)</span><br><span class="line">  elsif res.respond_to?<span class="keyword"> :each</span></span><br><span class="line">    body res</span><br><span class="line">  end</span><br><span class="line">  nil <span class="comment"># avoid double setting the same response tuple twice</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>The invoke function wrap and execute the handler codeblock ,catch the :halt<br>(which throw by route! as interrupt signal), and than set status, header and result to @response.</p>
<p>for example, when you execute the code wrapped by invoke, you can set the @response by throw :halt and Array response:</p>
<pre><code>invoke do 
  #do something...
  throw :halt ,[200,&quot;Hello world!&quot;] #this will go to @response
end
</code></pre><p>With the structure like this, error_block or other function can also throw :halt with result and return to user.</p>
<figure class="highlight smali"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Dispatch a request with error handling.</span></span><br><span class="line">def dispatch!</span><br><span class="line"> <span class="built_in"> invoke </span>do</span><br><span class="line">   <span class="keyword"> static</span>!<span class="built_in"> if </span>settings.static? &amp;&amp; (request.get? || request.head?)</span><br><span class="line">    filter!<span class="keyword"> :before</span></span><br><span class="line">    route!</span><br><span class="line">  end</span><br><span class="line">rescue<span class="keyword"> :</span>:Exception =&gt; boom</span><br><span class="line"> <span class="built_in"> invoke </span>&#123; handle_exception!(boom) &#125;</span><br><span class="line">ensure</span><br><span class="line">  filter!<span class="keyword"> :after</span> unless env['sinatra.static_file']</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In dispatch function, it check the static file first, than execute before filter, then execute the route! function follow by the after filter.</p>
<figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route!</span><span class="params">(base = settings, pass_block=<span class="literal">nil</span>)</span></span></span><br><span class="line">  <span class="keyword">if</span> routes = base.routes[@request.request_method]</span><br><span class="line">    routes.each <span class="keyword">do</span> <span class="params">|pattern, keys, conditions, block|</span></span><br><span class="line">      pass_block = process_route(pattern, keys, conditions) <span class="keyword">do</span> <span class="params">|*args|</span></span><br><span class="line">        route_eval &#123; block[*args] &#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Run routes defined in superclass.</span></span><br><span class="line">  <span class="keyword">if</span> base.superclass.respond_to?(<span class="symbol">:routes</span>)</span><br><span class="line">    <span class="keyword">return</span> route!(base.superclass, pass_block)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  route_eval(&amp;pass_block) <span class="keyword">if</span> pass_block</span><br><span class="line">  route_missing</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a route block and throw :halt with the result.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route_eval</span></span></span><br><span class="line">  throw <span class="symbol">:halt</span>, <span class="keyword">yield</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>At the bottom of execution stack, the route! function check the registered routes with request path and params.<br>If it find correct route, execute the codeblock and throw :halt with result. the invoke function will catch the :halt,<br>than set the result to @response.</p>
<p>If no route is executed, route_missing will be called and return not_found page. </p>
<h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><p>Sinatra is compatible with a lots of different templates, from erb, haml, markdown to sass, less…<br>almost any kind of templates that you can find, but how do Sinatra handle all of these different format?<br>It turns out using <a href="https://github.com/rtomayko/tilt" target="_blank" rel="noopener">Tilt</a> gem that includes all kinds of template engines.</p>
<p>For example, with Tilt, we can compile an erb template like this:</p>
<figure class="highlight d"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">require <span class="string">"tilt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> = Tilt[:erb]</span><br><span class="line"># =&gt; Tilt::ErubisTemplate </span><br><span class="line"></span><br><span class="line"># pass the file path or pass content <span class="keyword">body</span></span><br><span class="line">compiled_template = <span class="keyword">template</span>.<span class="keyword">new</span>(<span class="string">"path/to/file"</span>) &#123; <span class="string">"hello world"</span> &#125;</span><br><span class="line"># =&gt; &lt;Tilt::ErubisTemplate: ... <span class="keyword">@path</span>=<span class="string">"path/to/file"</span> <span class="keyword">@data</span> = <span class="string">"hello world"</span>&gt;</span><br><span class="line"></span><br><span class="line">compiled_template.render()</span><br><span class="line"># =&gt; <span class="string">"hello world"</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In application, we can call “erb” method to render erb template:</p>
<pre><code>get &quot;/&quot; do
  #render erb template in views/index.html.erb
  erb :index
end
</code></pre><p>under the hood in Template module:</p>
<figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">erb</span><span class="params">(template, options=&#123;&#125;, locals=&#123;&#125;)</span></span></span><br><span class="line">  render <span class="symbol">:erb</span>, template, options, locals</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(engine, data, options=&#123;&#125;, locals=&#123;&#125;, &amp;block)</span></span></span><br><span class="line">  <span class="comment"># merge app-level options</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment"># compile and render template</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    layout_was      = @default_layout</span><br><span class="line">    @default_layout = <span class="literal">false</span></span><br><span class="line">    template        = compile_template(engine, data, options, views)</span><br><span class="line">    output          = template.render(scope, locals, &amp;block)</span><br><span class="line">  <span class="keyword">ensure</span></span><br><span class="line">    @default_layout = layout_was</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># render layout</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  output</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compile_template</span><span class="params">(engine, data, options, views)</span></span></span><br><span class="line">  eat_errors = options.delete <span class="symbol">:eat_errors</span></span><br><span class="line">  template_cache.fetch engine, data, options <span class="keyword">do</span></span><br><span class="line">    template = Tilt[engine]</span><br><span class="line">    raise <span class="string">"Template engine not found: <span class="subst">#&#123;engine&#125;</span>"</span> <span class="keyword">if</span> template.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> data</span><br><span class="line">    <span class="keyword">when</span> Symbol</span><br><span class="line">      body, path, line = settings.templates[data]</span><br><span class="line">      <span class="keyword">if</span> body</span><br><span class="line">        body = body.call <span class="keyword">if</span> body.respond_to?(<span class="symbol">:call</span>)</span><br><span class="line">        template.new(path, line.to_i, options) &#123; body &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        found = <span class="literal">false</span></span><br><span class="line">        @preferred_extension = engine.to_s</span><br><span class="line">        find_template(views, data, template) <span class="keyword">do</span> <span class="params">|file|</span></span><br><span class="line">          path <span class="params">||</span>= file <span class="comment"># keep the initial path rather than the last one</span></span><br><span class="line">          <span class="keyword">if</span> found = File.exists?(file)</span><br><span class="line">            path = file</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        throw <span class="symbol">:layout_missing</span> <span class="keyword">if</span> eat_errors <span class="keyword">and</span> <span class="keyword">not</span> found</span><br><span class="line">        template.new(path, <span class="number">1</span>, options)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">when</span> Proc, String</span><br><span class="line">      body = data.is_a?(String) ? Proc.new &#123; data &#125; : data</span><br><span class="line">      path, line = settings.caller_locations.first</span><br><span class="line">      template.new(path, line.to_i, options, &amp;body)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise ArgumentError, <span class="string">"Sorry, don't know how to render <span class="subst">#&#123;data.inspect&#125;</span>."</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>First, the helper method will call the render method with format,<br>and render method compile the template and return output, than output will be catch by invoke method (in previous section)<br>and set to @response.</p>
<p>In compile_template, the Tilt engine will be called and return correct Tilt::Template instance.<br>here’s the digest version:</p>
<figure class="highlight sql"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def compile_template(engine, data, options, views)</span><br><span class="line">  template_cache.fetch engine, data, options <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">template</span> = Tilt[<span class="keyword">engine</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">body</span>, <span class="keyword">path</span>, line = settings.templates[<span class="keyword">data</span>]</span><br><span class="line">    <span class="keyword">body</span> = body.call <span class="keyword">if</span> body.respond_to?(:<span class="keyword">call</span>)</span><br><span class="line">    template.new(<span class="keyword">path</span>, line.to_i, options) &#123; <span class="keyword">body</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>The template_cache is an instance of Tilt::Cache, is a very simple hash implementation of cache:</p>
<pre><code>class Cache
    def initialize
      @cache = {}
    end

    def fetch(*key)
      @cache[key] ||= yield
    end

    def clear
      @cache = {}
    end
  end
end
</code></pre><h2 id="Streaming"><a href="#Streaming" class="headerlink" title="Streaming"></a>Streaming</h2><p>Stream is another interesting part in Sinatra, and probally one of the most complex part.<br>It use the <a href="http://rubyeventmachine.com/" target="_blank" rel="noopener">EventMachine</a> to implement streaming APIs that let you able to keep<br>sending data asynchronize without I/O blocking.<br>For example,</p>
<pre><code>get &apos;/&apos; do
  stream :keep_open do |out|
    out &lt;&lt; &quot;hello &quot;
    EventMachine.defer do 
      #something slow...
      sleep(3)
      out &lt;&lt; &quot;world&quot;
    end
  end
end
</code></pre><p>will output the responses chunk to user while the content is ready, and keep the connection open.<br>For doing that, it use the EventMachine.defer , EventMachine.schedule to create threads to avoid i/o blocking while generating result.</p>
<figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Allows to start sending data to the client even though later parts of</span></span><br><span class="line"><span class="comment"># the response body have not yet been generated.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The close parameter specifies whether Stream#close should be called</span></span><br><span class="line"><span class="comment"># after the block has been executed. This is only relevant for evented</span></span><br><span class="line"><span class="comment"># servers like Thin or Rainbows.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stream</span><span class="params">(keep_open = <span class="literal">false</span>)</span></span></span><br><span class="line">  scheduler = env[<span class="string">'async.callback'</span>] ? EventMachine : Stream</span><br><span class="line">  current   = @params.dup</span><br><span class="line"></span><br><span class="line">  block     = proc <span class="keyword">do</span> <span class="params">|out|</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      original, @params = @params, current</span><br><span class="line">      <span class="keyword">yield</span>(out)</span><br><span class="line">    <span class="keyword">ensure</span></span><br><span class="line">      @params = original <span class="keyword">if</span> original</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  out = Stream.new(scheduler, keep_open, &amp;block)</span><br><span class="line">  ...</span><br><span class="line">  body out</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>What stream method do is, first it detect the Server is support streamming or not. If so, use EventMachine.<br>And it wrap the code block with params, create a Stream instance than send it to body helper.<br>and body helper will send stream to Rack::Response.</p>
<figure class="highlight elixir"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">class Stream</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(scheduler = self.class, keep_open = <span class="keyword">false</span>, &amp;back)</span><br><span class="line">    <span class="variable">@back</span>, <span class="variable">@scheduler</span>, <span class="variable">@keep_open</span> = back.to_proc, scheduler, keep_open</span><br><span class="line">    <span class="variable">@callbacks</span>, <span class="variable">@closed</span> = [], <span class="keyword">false</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">each</span></span>(&amp;front)</span><br><span class="line">    <span class="variable">@front</span> = front</span><br><span class="line">    <span class="variable">@scheduler</span>.defer <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@back</span>.call(<span class="keyword">self</span>)</span><br><span class="line">      rescue Exception =&gt; e</span><br><span class="line">        <span class="variable">@scheduler</span>.schedule &#123; raise e &#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      close <span class="keyword">unless</span> <span class="variable">@keep_open</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> &lt;&lt;(<span class="title">data</span></span>)</span><br><span class="line">    <span class="variable">@scheduler</span>.schedule &#123; <span class="variable">@front</span>.call(data.to_s) &#125;</span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>According to Rack interface, the response body need to respond to “each” method.<br>The each method will be called with &amp;front block, which can sent result to user.<br>Stream class use the EventMachine.schedule to call codeblock asynchronizly,<br>and the &lt;&lt; method will sent data to @front with EventMachine.schedule.</p>
<h2 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h2><p>In sinatra, we can set configuration by “set” or “configure” method.</p>
<pre><code>set :server , :thin 

#or 
configure do 
  set :server, :thin
end
</code></pre><p>what configure do here is just call yield self, and act as a place for all settings.<br>And also those 2 methods are delegated methods. </p>
<p>What set doing here is a little different with normal setting methods:<br>It use the metaprogramming skills again.</p>
<p>while we call the set method,<br>it will generate getter and setter methods for self.server</p>
<pre><code>configure do |app|
    set :server, :thin 

    app.server # =&gt; :thin
    app.server = :unicorn # Application.server =&gt; :unicorn
end
</code></pre><figure class="highlight ruby"><figcaption><span>base.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Sets an option to the given value.  If the value is a proc,</span></span><br><span class="line"><span class="comment"># the proc will be called every time the option is accessed.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">set</span><span class="params">(option, value = (not_set = <span class="literal">true</span>)</span></span>, ignore_setter = <span class="literal">false</span>, &amp;block)</span><br><span class="line">  ...</span><br><span class="line">  setter = proc &#123; <span class="params">|val|</span> set option, val, <span class="literal">true</span> &#125;</span><br><span class="line">  getter = proc &#123; value &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> value</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">when</span> Symbol, Fixnum, FalseClass, TrueClass, NilClass</span><br><span class="line">    <span class="comment"># we have a lot of enable and disable calls, let's optimize those</span></span><br><span class="line">    class_eval <span class="string">"def self.<span class="subst">#&#123;option&#125;</span>() <span class="subst">#&#123;value.inspect&#125;</span> end"</span></span><br><span class="line">    getter = <span class="literal">nil</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  (<span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span>).class_eval <span class="keyword">do</span></span><br><span class="line">    define_method(<span class="string">"<span class="subst">#&#123;option&#125;</span>="</span>, &amp;setter) <span class="keyword">if</span> setter</span><br><span class="line">    define_method(option,       &amp;getter) <span class="keyword">if</span> getter</span><br><span class="line">    <span class="keyword">unless</span> method_defined? <span class="string">"<span class="subst">#&#123;option&#125;</span>?"</span></span><br><span class="line">      class_eval <span class="string">"def <span class="subst">#&#123;option&#125;</span>?() !!<span class="subst">#&#123;option&#125;</span> end"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Sinatra is a very simple and delegate web framework. It takes lots of advantage on ruby’s metaprogramming feature<br>to make code more digest and clean. Also with decent features support.(Template, Streaming, Filter, Route…)</p>
<p>The dsl syntax and delegator makes learning Sinatra application become very easy.<br>It will be great for implement api service or small website when you don’t need the heavy stacks like Rails.</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Jimchao</h4>
    <p>A developer, hacker, traveler and boarder live in New York City. You can follow my code at  <a href="http://github.com/rafe">Github</a></p>
</section>

      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://neethack.com/2012/02/code-odyssey-sinatra/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://neethack.com/2012/02/code-odyssey-sinatra/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://neethack.com/2012/02/code-odyssey-sinatra/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2012/02/bootstrap-2-dot-0/">
        ← Bootstrap 2.0
    </a>
    
    <span class="page-number">•</span>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Neethack</a> &copy; 2015 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>



<script type="text/javascript">
    var disqus_shortname = 'neethack';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
