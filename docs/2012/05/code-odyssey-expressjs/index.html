<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Code odyssey : Express | Neethack</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="Neethack">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
            
            <h1 class="blog-title"><a href="http://neethack.com">Neethack</a></h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>

  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2012-05-29T01:21:00.000Z" itemprop="datePublished">
          2012-05-28
      </time>
    
    
    | 
    <a href='/tags/javascript/'>javascript</a>
    
    
</span>
    <h1 class="post-title">Code odyssey : Express</h1>
    <section class="post-content">
      <p>Recently I was looking for web frameworks on Node.js. There are <a href="http://towerjs.org/" target="_blank" rel="noopener">Tower.js</a>, <a href="http://railwayjs.com/" target="_blank" rel="noopener">Railway</a>, <a href="http://geddyjs.org/" target="_blank" rel="noopener">GeddyJS</a>, <a href="http://socketstream.com/" target="_blank" rel="noopener">SocektStream</a>, <a href="https://github.com/meteor/meteor" target="_blank" rel="noopener">Meteor</a> and lots of cool framework on Node.js. However, Express, which created in the beginning of Node.js era, is still a very stable and easy to use framework with the most plugin and community support. Therefore, I think it is a good candidate as my 2nd source code review project.</p>
<p>Express.js is developed by <a href="https://github.com/visionmedia" target="_blank" rel="noopener">TJ Holowaychuk</a>, who rebuild the web development on Node.js with express, <a href="http://jade-lang.com/" target="_blank" rel="noopener">jade</a>, <a href="https://github.com/visionmedia/mocha" target="_blank" rel="noopener">mocha</a>, <a href="https://github.com/learnboost/stylus" target="_blank" rel="noopener">stylus</a> and more. Express is inspired by the simple of <a href="http://www.sinatrarb.com/" target="_blank" rel="noopener">Sinatra</a> provide a simple and elegant interface for http request, also with connect middle support that let user can easily extend the framework. </p>
<a id="more"></a>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>Here’s the hello world sample of express. It assign a callback for get request on root ‘/‘, and start the server to listen port 3000. More example can be found on <a href="https://github.com/visionmedia/express/tree/master/examples" target="_blank" rel="noopener">express/examples</a> and <a href="http://expressjs.com" target="_blank" rel="noopener">Documentation of express</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express.createServer();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  res.send(<span class="string">'Hello World'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Express started on port 3000'</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h2><p>Express is using the <a href="http://www.senchalabs.org/connect/" target="_blank" rel="noopener">Connect</a> Middleware. But What is connect? From the configuation function of Express:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.defaultConfiguration = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default settings</span></span><br><span class="line">  <span class="keyword">this</span>.set(<span class="string">'env'</span>, process.env.NODE_ENV || <span class="string">'development'</span>);</span><br><span class="line">  debug(<span class="string">'booting in %s mode'</span>, <span class="keyword">this</span>.get(<span class="string">'env'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// implicit middleware</span></span><br><span class="line">  <span class="keyword">this</span>.use(connect.query());</span><br><span class="line">  <span class="keyword">this</span>.use(middleware.init(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// router</span></span><br><span class="line">  <span class="keyword">this</span>._router = <span class="keyword">new</span> Router(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.routes = <span class="keyword">this</span>._router.map;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>We can see that express call the use method with connect.query(), the query() parse the query string and attach to the request object req.query.</p>
<p>In the source of connect.query():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">    req.query = ~req.url.indexOf(<span class="string">'?'</span>)</span><br><span class="line">      ? qs.parse(parse(req.url).query, options)</span><br><span class="line">      : &#123;&#125;;</span><br><span class="line">    next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The next() method invoke the next method on the process chain.<br>We can see that it return a method that parse the req.url with qs.parse function and return to req.query. So we can get the query string from req.query in our application.</p>
<p>So we can see the middleware as a function that execute before the request and add functionality to (req, res) object. So we can easily use a function as middleware. In example, we can refactor the hello world as middleware:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express.createServer();</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  req.message = <span class="string">'Hello world'</span>;</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  res.send(req.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Express started on port 3000'</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In more advance usage, we can build a <strong>flash</strong> message using middleware:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  res.locals.flash = req.session.flash || <span class="string">""</span>;</span><br><span class="line">  req.session.flash = <span class="string">""</span>;</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Also, there is another kind middleware called param callback. which will only be executed when the route have the param key:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.param(<span class="string">'user_id'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next, id</span>)</span>&#123;</span><br><span class="line">  User.find(id, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      next(err);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user) &#123;</span><br><span class="line">      req.user = user;</span><br><span class="line">      next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'failed to load user'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Will be invoked when route params have ‘user_id’:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.get(<span class="string">'/:user_id'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  send(<span class="string">'User name is'</span> + req.user.name );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><p>The main application is on lib/express.js. It produce express app by <strong>createApplication</strong> function. First, the application merge with <strong>connect</strong>, set request and response object, than call the initialize function of application defined in lib/application.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>)</span><br><span class="line">  , proto = <span class="built_in">require</span>(<span class="string">'./application'</span>)</span><br><span class="line">  , req = <span class="built_in">require</span>(<span class="string">'./request'</span>)</span><br><span class="line">  , res = <span class="built_in">require</span>(<span class="string">'./response'</span>)</span><br><span class="line">  </span><br><span class="line">…</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApplication</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = connect();</span><br><span class="line">  utils.merge(app, proto);</span><br><span class="line">  app.request = &#123; <span class="attr">__proto__</span>: req &#125;;</span><br><span class="line">  app.response = &#123; <span class="attr">__proto__</span>: res &#125;;</span><br><span class="line">  app.init();</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In application.js, the <strong>init</strong> function initialize the settings and default configuration of express, and also load the Router to route the Http requests. </p>
<p>Also an important part, some of the settings is depend on <strong>process.env</strong>, like cache. Which can be enabled by exports NODE_ENV=production.</p>
<pre><code>this.set(&apos;env&apos;, process.env.NODE_ENV || &apos;development&apos;);
</code></pre><h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><p>Lets step into the router, basically, the router provide <em>route</em> method to assign function to route, and <em>matchRequest</em> to return route.</p>
<p>In <em>route</em></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Route `method`, `path`, and one or more callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">method</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">path</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>callback...</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Router&#125;</span> </span>for chaining</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@api <span class="variable">private</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">Router.prototype.route = <span class="function"><span class="keyword">function</span>(<span class="params">method, path, callbacks</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> method = method.toLowerCase()</span><br><span class="line">    , callbacks = utils.flatten([].slice.call(<span class="built_in">arguments</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ensure path was given</span></span><br><span class="line">  <span class="keyword">if</span> (!path) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Router#'</span> + method + <span class="string">'() requires a path'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create the route</span></span><br><span class="line">  debug(<span class="string">'defined %s %s'</span>, method, path);</span><br><span class="line">  <span class="keyword">var</span> route = <span class="keyword">new</span> Route(method, path, callbacks, &#123;</span><br><span class="line">      sensitive: <span class="keyword">this</span>.caseSensitive</span><br><span class="line">    , <span class="attr">strict</span>: <span class="keyword">this</span>.strict</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add it</span></span><br><span class="line">  (<span class="keyword">this</span>.map[method] = <span class="keyword">this</span>.map[method] || []).push(route);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The route function take the Http method (like ‘get’), path and callback. normalize them and create Route object. add to the <strong>map[method]</strong> array in Router.</p>
<p>Also, it use the meta programming skill to generate public helper for user, so we can call the <strong>app.get</strong> or <strong>app.post</strong> method to assign route.</p>
<p>In application.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> methods = <span class="built_in">require</span>(<span class="string">'methods'</span>)</span><br><span class="line"></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate `.VERB(...)` calls to `.route(VERB, ...)`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</span><br><span class="line">  app[method] = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'get'</span> == method &amp;&amp; <span class="number">1</span> == <span class="built_in">arguments</span>.length) <span class="keyword">return</span> <span class="keyword">this</span>.set(path); </span><br><span class="line">    <span class="keyword">var</span> args = [method].concat([].slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._usedRoutnner) <span class="keyword">this</span>.use(<span class="keyword">this</span>.router);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._router.route.apply(<span class="keyword">this</span>._router, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>But after the route is set, how do express invoke the handle function? We can see the usage from the test case:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'.middleware'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  it(<span class="string">'should dispatch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    router.route(<span class="string">'get'</span>, <span class="string">'/foo'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">      res.send(<span class="string">'foo'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.use(router.middleware);</span><br><span class="line"></span><br><span class="line">    request(app)</span><br><span class="line">    .get(<span class="string">'/foo'</span>)</span><br><span class="line">    .expect(<span class="string">'foo'</span>, done);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>In the test case we can see the <strong>app.use(router.middleware)</strong> mount the routes to the application. In <strong>router.middleware</strong>, it call the <strong>_dispatch(req, res, next)</strong> function,<br>it call the <strong>route.matchRequest</strong> method to get the matched route, handle param callback and execute the callback chain:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Router.prototype._dispatch = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> params = <span class="keyword">this</span>.params</span><br><span class="line">    , self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'dispatching %s %s (%s)'</span>, req.method, req.url, req.originalUrl);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// route dispatch</span></span><br><span class="line">  (<span class="function"><span class="keyword">function</span> <span class="title">pass</span>(<span class="params">i, err</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// match next route</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">nextRoute</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      pass(req._route_index + <span class="number">1</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// match route</span></span><br><span class="line">    req.route = route = self.matchRequest(req, i);</span><br><span class="line"></span><br><span class="line">	…</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// we have a route</span></span><br><span class="line">    <span class="comment">// start at param 0</span></span><br><span class="line">    req.params = route.params;</span><br><span class="line">    keys = route.keys;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// param callbacks</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    … <span class="comment">// execute param callbacks and execute route callbacks(err) in the end.</span></span><br><span class="line">    </span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    param(err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// invoke route callbacks</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callbacks</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> fn = route.callbacks[i++];</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'route'</span> == err) &#123;</span><br><span class="line">          nextRoute();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err &amp;&amp; fn) &#123;</span><br><span class="line">          <span class="keyword">if</span> (fn.length &lt; <span class="number">4</span>) <span class="keyword">return</span> callbacks(err);</span><br><span class="line">          fn(err, req, res, callbacks);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fn) &#123;</span><br><span class="line">          fn(req, res, callbacks);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          nextRoute(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        callbacks(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)(<span class="number">0</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Request-Response"><a href="#Request-Response" class="headerlink" title="Request / Response"></a>Request / Response</h2><p>Request and Response object in express is inheritate http.IncomingMessage and http.ServerResponse from node. Request provide helpers for http header, content-type, URL and param parsing. </p>
<p>Response is providing helpers for status and results too. Also provide the send function from ‘response-send’ module. Which detect response type and set corresponding content-type.</p>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><p>In the <strong>lib/view.js</strong>, the main functions is <strong>render</strong> and <strong>lookup</strong>, which find the template and call the render function on engine. The <strong>render</strong> function on app initialize new View, the view set the <strong>lookup(name)</strong> to <strong>path</strong>, and call the <strong>view.render</strong> method to return result:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">View.prototype.lookup = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ext = <span class="keyword">this</span>.ext;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &lt;path&gt;.&lt;engine&gt;</span></span><br><span class="line">  <span class="keyword">if</span> (!utils.isAbsolute(path)) path = join(<span class="keyword">this</span>.root, path);</span><br><span class="line">  <span class="keyword">if</span> (exists(path)) <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &lt;path&gt;/index.&lt;engine&gt;</span></span><br><span class="line">  path = join(dirname(path), basename(path, ext), <span class="string">'index'</span> + ext);</span><br><span class="line">  <span class="keyword">if</span> (exists(path)) <span class="keyword">return</span> path;</span><br><span class="line">&#125;;</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line">View.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params">options, fn</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.engine(<span class="keyword">this</span>.path, options, fn);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>in the app.render:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app.render = <span class="function"><span class="keyword">function</span>(<span class="params">name, options, fn</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span></span><br><span class="line">    , opts = &#123;&#125;</span><br><span class="line">    , cache = <span class="keyword">this</span>.cache</span><br><span class="line">    , engines = <span class="keyword">this</span>.engines</span><br><span class="line">    , view;</span><br><span class="line"></span><br><span class="line">  …</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// primed cache</span></span><br><span class="line">  <span class="keyword">if</span> (opts.cache) view = cache[name];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// view</span></span><br><span class="line">  <span class="keyword">if</span> (!view) &#123;</span><br><span class="line">    view = <span class="keyword">new</span> View(name, &#123;</span><br><span class="line">        defaultEngine: <span class="keyword">this</span>.get(<span class="string">'view engine'</span>)</span><br><span class="line">      , <span class="attr">root</span>: <span class="keyword">this</span>.get(<span class="string">'views'</span>) || process.cwd() + <span class="string">'/views'</span></span><br><span class="line">      , <span class="attr">engines</span>: engines</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!view.path) &#123;</span><br><span class="line">      <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Failed to lookup view "'</span> + name + <span class="string">'"'</span>);</span><br><span class="line">      err.view = view;</span><br><span class="line">      <span class="keyword">return</span> fn(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prime the cache</span></span><br><span class="line">    <span class="keyword">if</span> (opts.cache) cache[name] = view;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    view.render(opts, fn);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    fn(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="MVC-example"><a href="#MVC-example" class="headerlink" title="MVC example"></a>MVC example</h2><p>In the examples/mvc directory, it shows you how to structure a mvc style application in express.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">controllers/</span><br><span class="line">  main/</span><br><span class="line">  pet/</span><br><span class="line">  user-pet/</span><br><span class="line">  user/</span><br><span class="line">views/</span><br><span class="line">public/</span><br><span class="line">lib/</span><br><span class="line">  boot.js</span><br><span class="line">db.js</span><br><span class="line">index.js</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The followed structure is a sample of mvc in express, the index.js load the boot.js, which mount all the routes under controllers/ in a RESTful style. And set the views path and static path.</p>
<p>There are no restriction on how to build the structure of express application. The <a href="http://railwayjs.com" target="_blank" rel="noopener">Railway</a> is one of the example that it extend express to be a Rails like Mvc application.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Express is a lightweight web framework and it is a good entry point to know how to build a web framework in Node.js. Hope this walkthrough can help you understand how express work. And can be more comfortable with new framework like meteor.</p>
<p>Also it is a well styled and documented project, so when you find some problem in developing express application, don’t be hesitate to use the source code (luke!) and the Guide of <a href="http://expressjs.com/" target="_blank" rel="noopener">Express</a></p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Jimchao</h4>
    <p>A developer, hacker, traveler and boarder live in New York City. You can follow my code at  <a href="http://github.com/rafe">Github</a></p>
</section>

      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://neethack.com/2012/05/code-odyssey-expressjs/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://neethack.com/2012/05/code-odyssey-expressjs/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://neethack.com/2012/05/code-odyssey-expressjs/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2012/07/announcing-n37-url-shortener/">
        ← Announcing N37 url shortener
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2012/04/go-programming/">
        Go Programming Example →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Neethack</a> &copy; 2015 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>



<script type="text/javascript">
    var disqus_shortname = 'neethack';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
