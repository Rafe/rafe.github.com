getAlgorithms = -> ['md5', 'sha1', 'sha256', 'sha512']

generateCode = (url, algorithms, digits, callback)->
  #increase code digits if all codes are registered
  if algorithms.length is 0
    algorithms = getAlgorithms()
    digits += 1

  algorithm = algorithms.shift()

  code = hashUrl(url, digits, algorithm)

  redis.get "url:#{code}", (err, reply)->
    if not reply or reply == url
      client.set "url:#{code}", url, (err, reply)->
        callback(null, code)
    else generateCode(url, algorithms, digits, callback)