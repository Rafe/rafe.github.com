<div class="highlight"><pre><span class="o">&lt;</span><span class="sr">/p&gt;</span>

<span class="sr">&lt;p&gt;class App&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">class</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="nb">self</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>

<span class="sr">&lt;pre&gt;&lt;code&gt;attr_reader :routes </span>

<span class="sr">def get(path, options={}, &amp;amp;block)</span>
<span class="sr">  route(&quot;GET&quot;, path, options, &amp;amp;block)</span>
<span class="sr">end</span>

<span class="sr">def route(verb, path, options, &amp;amp;block)</span>
<span class="sr">  @routes ||= {}</span>
<span class="sr">  signature = compile!(verb, path, block, options)</span>
<span class="sr">  @routes[verb] ||= []</span>
<span class="sr">  @routes[verb] &amp;lt;&amp;lt; signature</span>
<span class="sr">end</span>

<span class="sr">def compile!(verb, path, block, options)</span>
<span class="sr">  unbound_method = generate_method(&quot;</span><span class="si">#{</span><span class="n">verb</span><span class="si">}</span><span class="sr"> </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="sr">&quot;,&amp;amp;block)</span>

<span class="sr">  [path, proc {|base| unbinded_method.bind(base).call() } ]</span>
<span class="sr">end</span>

<span class="sr">def generate_method(method_name, &amp;amp;block)</span>
<span class="sr">  define_method(method_name, &amp;amp;block)</span>
<span class="sr">  method = instance_method method_name</span>
<span class="sr">  remove_method method_name</span>
<span class="sr">  method</span>
<span class="sr">end</span>
<span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>

<span class="sr">&lt;p&gt;  end</span>
<span class="sr">end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">App</span><span class="o">.</span><span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
  <span class="s2">&quot;Hello world&quot;</span>
<span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>

<span class="sr">&lt;p&gt;base = App.new&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">App</span><span class="o">.</span><span class="n">routes</span><span class="o">[</span><span class="s2">&quot;GET&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="mi">1</span><span class="o">].</span><span class="n">call</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>

<span class="sr">&lt;h1&gt;print:: &quot;Hello world&quot;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</pre>
</div>
