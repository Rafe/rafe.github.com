<div class="highlight"><pre><span class="c1"># Dispatch a request with error handling.</span>
<span class="k">def</span> <span class="nf">dispatch!</span>
  <span class="n">invoke</span> <span class="k">do</span>
    <span class="n">static!</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">static?</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get?</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">head?</span><span class="p">)</span>
    <span class="n">filter!</span> <span class="ss">:before</span>
    <span class="n">route!</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="o">::</span><span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">boom</span>
  <span class="n">invoke</span> <span class="p">{</span> <span class="n">handle_exception!</span><span class="p">(</span><span class="n">boom</span><span class="p">)</span> <span class="p">}</span>
<span class="k">ensure</span>
  <span class="n">filter!</span> <span class="ss">:after</span> <span class="k">unless</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;sinatra.static_file&#39;</span><span class="o">]</span>
<span class="k">end</span>
</pre>
</div>
